<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chuyến đi - DC Booking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <button class="btn btn-link text-white p-0 me-3" id="sidebar-toggle" type="button">
                <i class="fas fa-bars fa-lg"></i>
            </button>
            <a class="navbar-brand fw-bold" href="../index.html">
                <i class="fas fa-car"></i> DC Booking
            </a>
            <div class="ms-auto" id="auth-nav">
                <a class="btn btn-link text-white text-decoration-none" href="#" onclick="showAuthModal()">Đăng nhập</a>
            </div>
            <div class="ms-auto d-none" id="user-nav">
                <div class="dropdown">
                    <a class="btn btn-link text-white text-decoration-none dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <span id="user-name"></span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="profile.html"><i class="fas fa-user me-2"></i>Hồ sơ cá nhân</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Đăng xuất</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar Menu -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <div class="sidebar-menu" id="sidebar-menu">
        <div class="sidebar-header">
            <h5 class="mb-0"><i class="fas fa-car"></i> Menu</h5>
            <button class="btn-close btn-close-white" id="sidebar-close"></button>
        </div>
        <div class="sidebar-body">
            <!-- Status Toggle (driver) -->
            <div class="status-toggle-container mb-3" id="driver-status-section">
                <div class="status-toggle" id="status-container">
                    <div>
                        <h6 class="mb-0" id="status-title">
                            <i class="fas fa-circle me-2" id="status-icon"></i>
                            <span id="status-text">Đang tải...</span>
                        </h6>
                        <small class="text-muted" id="status-description">Đang kiểm tra trạng thái</small>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="statusToggle" onchange="toggleDriverStatus()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="mt-2 text-center" id="status-info">
                    <small class="text-muted">Bật để nhận chuyến đi mới</small>
                </div>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item d-none" id="home-nav-sidebar">
                    <a class="nav-link" href="../index.html"><i class="fas fa-home me-2"></i>Trang chủ</a>
                </li>
                <li class="nav-item d-none" id="booking-nav-sidebar">
                    <a class="nav-link" href="booking.html" data-auth><i class="fas fa-calendar-check me-2"></i>Đặt xe</a>
                </li>
                <li class="nav-item d-none" id="trips-nav-sidebar">
                    <a class="nav-link" href="trips.html" data-auth><i class="fas fa-route me-2"></i>Chuyến đi</a>
                </li>
                <li class="nav-item d-none" id="drivers-nav-sidebar">
                    <a class="nav-link" href="drivers.html"><i class="fas fa-user-tie me-2"></i>Tài xế</a>
                </li>
                <li class="nav-item d-none" id="stats-menu-item-sidebar">
                    <a class="nav-link" href="driver-dashboard.html"><i class="fas fa-chart-bar me-2"></i>Thống kê</a>
                </li>
                <li class="nav-item d-none" id="promotions-nav-sidebar">
                    <a class="nav-link" href="promotions.html"><i class="fas fa-gift me-2"></i>Khuyến mãi</a>
                </li>
                <li class="nav-item d-none" id="driverreg-nav-sidebar">
                    <a class="nav-link" href="../driver-registration.html"><i class="fas fa-user-plus me-2"></i>Đăng ký tài xế</a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container my-5 page-content">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h2><i class="fas fa-route me-2"></i>Chuyến đi của tôi</h2>
                <p class="text-muted">Quản lý và theo dõi các chuyến đi</p>
            </div>
            <div class="col-md-4 text-end">
                <a id="book-new-btn" href="booking.html" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Đặt xe mới
                </a>
            </div>
        </div>

        <!-- Filter and Search -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Trạng thái</label>
                        <select class="form-select" id="status-filter">
                            <option value="">Tất cả trạng thái</option>
                            <option value="cho_xac_nhan">Chờ xác nhận</option>
                            <option value="da_xac_nhan">Đã xác nhận</option>
                            <option value="dang_thuc_hien">Đang thực hiện</option>
                            <option value="hoan_thanh">Hoàn thành</option>
                            <option value="da_huy">Đã hủy</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Từ ngày</label>
                        <input type="date" class="form-control" id="date-from">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Đến ngày</label>
                        <input type="date" class="form-control" id="date-to">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-outline-primary me-2" onclick="applyFilters()">
                            <i class="fas fa-filter me-2"></i>Lọc
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="fas fa-times me-2"></i>Xóa
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trips List -->
        <div id="trips-container">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Đang tải danh sách chuyến đi...</p>
            </div>
        </div>

        <!-- Pagination -->
        <nav aria-label="Trips pagination" class="mt-4">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be generated here -->
            </ul>
        </nav>
    </div>

    <!-- Trip Detail Modal -->
    <div class="modal fade" id="tripDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi tiết chuyến đi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="trip-detail-content">
                    <!-- Trip details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-danger" id="cancel-trip-btn" style="display: none;">
                        <i class="fas fa-times me-2"></i>Hủy chuyến
                    </button>
                    <button type="button" class="btn btn-primary" id="rate-trip-btn" style="display: none;">
                        <i class="fas fa-star me-2"></i>Đánh giá
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rating Modal -->
    <div class="modal fade" id="ratingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Đánh giá chuyến đi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="rating-form">
                        <input type="hidden" id="rating-trip-id">
                        
                        <div class="mb-3">
                            <label class="form-label">Đánh giá tài xế</label>
                            <div class="rating-stars mb-2">
                                <i class="fas fa-star star" data-rating="1"></i>
                                <i class="fas fa-star star" data-rating="2"></i>
                                <i class="fas fa-star star" data-rating="3"></i>
                                <i class="fas fa-star star" data-rating="4"></i>
                                <i class="fas fa-star star" data-rating="5"></i>
                            </div>
                            <input type="hidden" id="driver-rating" value="5">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Nhận xét</label>
                            <textarea class="form-control" id="review-comment" rows="3" 
                                      placeholder="Chia sẻ trải nghiệm của bạn..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="submitRating()">
                        <i class="fas fa-paper-plane me-2"></i>Gửi đánh giá
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alert-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/notifications.js"></script>
    <script src="/js/app.js"></script>
    <script>
        // Ẩn driver status nếu không phải tài xế
        document.addEventListener('DOMContentLoaded', function() {
            try {
                let role = localStorage.getItem('role');
                if (!role && localStorage.getItem('user')) {
                    const user = JSON.parse(localStorage.getItem('user'));
                    role = user && user.role ? user.role : null;
                }
                if (role !== 'tai_xe') {
                    const statusSection = document.getElementById('driver-status-section');
                    if (statusSection) statusSection.style.display = 'none';
                }
            } catch (e) { /* ignore */ }
        });
        async function loadDriverStatus() {
            try {
                const token = localStorage.getItem('token'); if (!token) return;
                const res = await fetch(`${window.API_BASE_URL}/drivers/my-status`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json(); if (data && data.success && data.data) updateStatusUI(data.data.trang_thai_tai_xe);
            } catch (e) { console.debug('loadDriverStatus', e); }
        }
        function updateStatusUI(status) {
            const container = document.getElementById('status-container');
            const toggle = document.getElementById('statusToggle');
            const icon = document.getElementById('status-icon');
            const text = document.getElementById('status-text');
            const description = document.getElementById('status-description');
            if (!container || !toggle) return;
            if (status === 'san_sang') { container.classList.add('active'); container.classList.remove('inactive'); toggle.checked = true; icon.className='fas fa-circle me-2'; text.textContent='Đang hoạt động'; description.textContent='Bạn có thể nhận chuyến đi mới'; }
            else { container.classList.remove('active'); container.classList.add('inactive'); toggle.checked = false; icon.className='fas fa-moon me-2'; text.textContent='Không hoạt động'; description.textContent='Bật để bắt đầu nhận chuyến'; }
        }
        async function toggleDriverStatus() {
            const toggle = document.getElementById('statusToggle'); if (!toggle) return;
            const newStatus = toggle.checked ? 'san_sang' : 'nghi_lam';
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${window.API_BASE_URL}/drivers/status`, { method: 'POST', headers: { 'Content-Type':'application/json','Authorization':`Bearer ${token}` }, body: JSON.stringify({ trang_thai: newStatus }) });
                const data = await res.json(); if (data && data.success) { updateStatusUI(newStatus); showNotification(toggle.checked ? 'Đã bật trạng thái hoạt động' : 'Đã tắt trạng thái hoạt động','success'); } else { toggle.checked = !toggle.checked; showNotification('Không thể thay đổi trạng thái','error'); }
            } catch (e) { console.error(e); toggle.checked = !toggle.checked; showNotification('Lỗi khi thay đổi trạng thái','error'); }
        }
        document.addEventListener('DOMContentLoaded', () => setTimeout(loadDriverStatus, 600));
    </script>
    <script>
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {};

        document.addEventListener('DOMContentLoaded', function() {
            loadTrips();
            
            // Setup rating stars
            setupRatingStars();
        });

        async function loadTrips(page = 1) {
            if (!dcApp.token) {
                document.getElementById('trips-container').innerHTML = `
                    <div class="text-center">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Vui lòng đăng nhập để xem chuyến đi
                        </div>
                    </div>
                `;
                return;
            }

            try {
                const queryParams = new URLSearchParams({
                    page: page,
                    limit: 10,
                    ...currentFilters
                });

                const response = await fetch(`${API_BASE_URL}/trips/user?${queryParams}`, {
                    headers: {
                        'Authorization': `Bearer ${dcApp.token}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    displayTrips(result.data.trips);
                    setupPagination(result.data.pagination);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Load trips error:', error);
                document.getElementById('trips-container').innerHTML = `
                    <div class="text-center">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Lỗi khi tải danh sách chuyến đi
                        </div>
                    </div>
                `;
            }
        }

        function displayTrips(trips) {
            const container = document.getElementById('trips-container');
            
            if (trips.length === 0) {
                container.innerHTML = `
                    <div class="text-center">
                        <div class="card shadow-sm">
                            <div class="card-body py-5">
                                <i class="fas fa-car fa-3x text-muted mb-3"></i>
                                <h5>Chưa có chuyến đi nào</h5>
                                <p class="text-muted">Hãy đặt chuyến đi đầu tiên của bạn!</p>
                                <a href="booking.html" class="btn btn-primary book-now-btn">
                                    <i class="fas fa-plus me-2"></i>Đặt xe ngay
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            let html = '';
            trips.forEach(trip => {
                const statusInfo = getStatusInfo(trip.trang_thai);
                const formattedDate = new Date(trip.thoi_gian_don).toLocaleString('vi-VN');
                const price = trip.gia_cuoc ? new Intl.NumberFormat('vi-VN').format(trip.gia_cuoc) + ' VND' : 'Chưa xác định';

                html += `
                        <div class="card shadow-sm mb-3 trip-card-clickable" onclick="viewTripDetail(${trip.id})" role="button" tabindex="0" onkeydown="if(event.key==='Enter') viewTripDetail(${trip.id})">
                            <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-center mb-2">
                                        <h6 class="mb-0 me-3">Chuyến đi #${trip.id}</h6>
                                        <span class="badge ${statusInfo.class}">${statusInfo.text}</span>
                                    </div>
                                    
                                    <div class="trip-route mb-2">
                                        <div class="d-flex align-items-center mb-1">
                                            <i class="fas fa-map-marker-alt text-success me-2"></i>
                                            <strong>Điểm đón:</strong> <span class="ms-2">${trip.diem_don}</span>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                            <strong>Điểm đến:</strong> <span class="ms-2">${trip.diem_den}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="trip-info text-muted">
                                        <small>
                                            <i class="fas fa-clock me-1"></i> ${formattedDate}
                                            ${trip.loai_xe ? `<i class="fas fa-car ms-3 me-1"></i> ${trip.loai_xe}` : ''}
                                        </small>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 text-md-end">
                                    <div class="price mb-2">
                                        <h5 class="text-primary mb-0">${price}</h5>
                                    </div>
                                    
                                    <div class="actions">
                                        <!-- Card is clickable for details; keep action buttons for cancel/rate only -->
                                        ${trip.trang_thai === 'cho_xac_nhan' || trip.trang_thai === 'da_xac_nhan' ? 
                                            `<button class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); cancelTrip(${trip.id})">
                                                <i class="fas fa-times me-1"></i>Hủy
                                            </button>` : ''
                                        }
                                        ${trip.trang_thai === 'hoan_thanh' 
                                           && !trip.da_danh_gia 
                                           && window.dcApp 
                                           && window.dcApp.user 
                                           && window.dcApp.user.loai_tai_khoan === 'khach_hang'
                                           && Number(trip.khach_hang_id) === Number(window.dcApp.user.id)
                                           ? `<button class="btn btn-outline-warning btn-sm" onclick="event.stopPropagation(); rateTrip(${trip.id})">
                                                <i class="fas fa-star me-1"></i>Đánh giá
                                             </button>` : ''
                                        }
                                        ${trip.trang_thai === 'hoan_thanh' 
                                           && trip.da_danh_gia 
                                           && window.dcApp 
                                           && window.dcApp.user 
                                           && window.dcApp.user.loai_tai_khoan === 'khach_hang'
                                           ? `<span class="badge bg-success"><i class="fas fa-check me-1"></i>Đã đánh giá</span>` : ''
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function getStatusInfo(status) {
            const statusMap = {
                'cho_tai_xe': { text: 'Chờ tài xế', class: 'bg-warning text-dark' },
                'cho_xac_nhan': { text: 'Chờ xác nhận', class: 'bg-warning text-dark' },
                'da_xac_nhan': { text: 'Đã xác nhận', class: 'bg-info text-white' },
                'dang_thuc_hien': { text: 'Đang thực hiện', class: 'bg-primary text-white' },
                'hoan_thanh': { text: 'Hoàn thành', class: 'bg-success text-white' },
                'da_huy': { text: 'Đã hủy', class: 'bg-danger text-white' }
            };
            return statusMap[status] || { text: status, class: 'bg-secondary text-white' };
        }

        function setupPagination(pagination) {
            totalPages = pagination.totalPages;
            currentPage = pagination.currentPage;
            
            const paginationContainer = document.getElementById('pagination');
            let html = '';

            // Previous button
            html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link pagination-btn" href="#" onclick="loadTrips(${currentPage - 1})">Trước</a>
                </li>
            `;

            // Page numbers
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link pagination-btn" href="#" onclick="loadTrips(${i})">${i}</a>
                        </li>
                `;
            }

            // Next button
            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link pagination-btn" href="#" onclick="loadTrips(${currentPage + 1})">Sau</a>
                </li>
            `;

            paginationContainer.innerHTML = html;
        }

        function applyFilters() {
            currentFilters = {
                status: document.getElementById('status-filter').value,
                date_from: document.getElementById('date-from').value,
                date_to: document.getElementById('date-to').value
            };

            // Remove empty filters
            Object.keys(currentFilters).forEach(key => {
                if (!currentFilters[key]) {
                    delete currentFilters[key];
                }
            });

            loadTrips(1);
        }

        function clearFilters() {
            document.getElementById('status-filter').value = '';
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            currentFilters = {};
            loadTrips(1);
        }

        async function viewTripDetail(tripId) {
            try {
                const response = await fetch(`${API_BASE_URL}/trips/${tripId}`, {
                    headers: {
                        'Authorization': `Bearer ${dcApp.token}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    displayTripDetail(result.data);
                    const modal = new bootstrap.Modal(document.getElementById('tripDetailModal'));
                    modal.show();
                } else {
                    showAlert('error', 'Không thể tải chi tiết chuyến đi');
                }
            } catch (error) {
                console.error('Load trip detail error:', error);
                showAlert('error', 'Lỗi khi tải chi tiết chuyến đi');
            }
        }

        function displayTripDetail(trip) {
            const statusInfo = getStatusInfo(trip.trang_thai);
            const formattedDate = new Date(trip.thoi_gian_don).toLocaleString('vi-VN');
            const price = trip.gia_cuoc ? new Intl.NumberFormat('vi-VN').format(trip.gia_cuoc) + ' VND' : 'Chưa xác định';

            let content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Thông tin chuyến đi</h6>
                        <table class="table table-borderless">
                            <tr><td><strong>Mã chuyến:</strong></td><td>#${trip.id}</td></tr>
                            <tr><td><strong>Trạng thái:</strong></td><td><span class="badge ${statusInfo.class}">${statusInfo.text}</span></td></tr>
                            <tr><td><strong>Thời gian đón:</strong></td><td>${formattedDate}</td></tr>
                            <tr><td><strong>Loại xe:</strong></td><td>${trip.loai_xe || 'Chưa xác định'}</td></tr>
                            <tr><td><strong>Giá cước:</strong></td><td class="text-primary"><strong>${price}</strong></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Lộ trình</h6>
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-map-marker-alt text-success me-2"></i>
                                <div>
                                    <strong>Điểm đón</strong><br>
                                    <span class="text-muted">${trip.diem_don}</span>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                <div>
                                    <strong>Điểm đến</strong><br>
                                    <span class="text-muted">${trip.diem_den}</span>
                                </div>
                            </div>
                        </div>
                        ${trip.ghi_chu ? `
                            <h6>Ghi chú</h6>
                            <p class="text-muted">${trip.ghi_chu}</p>
                        ` : ''}
                    </div>
                </div>
            `;

            // Build driver info from possible shapes returned by the API
            let driverInfo = null;
            if (trip.tai_xe && typeof trip.tai_xe === 'object') {
                driverInfo = trip.tai_xe;
            } else if (trip.ten_tai_xe || trip.sdt_tai_xe || trip.sdt_khach_hang) {
                driverInfo = {
                    id: trip.tai_xe_id || trip.tai_xeId || null,
                    ten: trip.ten_tai_xe || trip.nd_tx || trip.ten || null,
                    so_dien_thoai: trip.sdt_tai_xe || trip.sdt_khach_hang || trip.so_dien_thoai || null,
                    loai_xe: trip.loai_xe || null,
                    bien_so_xe: trip.bien_so_xe || null,
                    mau_xe: trip.mau_xe || null,
                    rating: trip.tai_xe_diem || trip.diem_tai_xe || null,
                    avatar: trip.tai_xe_avatar || trip.avatar || null
                };
            }

            if (driverInfo) {
                content += `
                    <hr>
                    <h6>Thông tin tài xế</h6>
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            ${driverInfo.avatar ? `<img src="${driverInfo.avatar}" alt="${driverInfo.ten || 'Tài xế'}" style="width:64px;height:64px;border-radius:50%;object-fit:cover;">` : `<i class="fas fa-user-circle fa-3x text-primary"></i>`}
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${driverInfo.ten || 'Tài xế'}</h6>
                            <p class="mb-1 text-muted">
                                <i class="fas fa-phone me-1"></i>
                                ${driverInfo.so_dien_thoai ? `<a href="tel:${driverInfo.so_dien_thoai}" class="text-decoration-none">${driverInfo.so_dien_thoai}</a>` : 'Không có số'}
                            </p>
                            <p class="mb-1 text-muted">
                                <i class="fas fa-car me-1"></i>
                                ${driverInfo.loai_xe || '-'} ${driverInfo.bien_so_xe ? '• ' + driverInfo.bien_so_xe : ''} ${driverInfo.mau_xe ? '• ' + driverInfo.mau_xe : ''}
                            </p>
                            ${driverInfo.rating ? `<p class="mb-0"><span class="badge bg-warning text-dark"><i class="fas fa-star me-1"></i>${Number(driverInfo.rating).toFixed(1)}</span></p>` : ''}
                        </div>
                        <div class="text-end">
                            ${driverInfo.id ? `<a href="/views/driver-detail.html?id=${driverInfo.id}" class="btn btn-sm btn-primary"><i class="fas fa-user me-1"></i>Xem hồ sơ</a>` : ''}
                        </div>
                    </div>
                `;
            }

            document.getElementById('trip-detail-content').innerHTML = content;

            // Show/hide action buttons
            const cancelBtn = document.getElementById('cancel-trip-btn');
            const rateBtn = document.getElementById('rate-trip-btn');
            
            cancelBtn.style.display = (trip.trang_thai === 'cho_xac_nhan' || trip.trang_thai === 'da_xac_nhan') ? 'block' : 'none';
            rateBtn.style.display = (trip.trang_thai === 'hoan_thanh' && !trip.da_danh_gia) ? 'block' : 'none';

            cancelBtn.onclick = () => cancelTrip(trip.id);
            rateBtn.onclick = () => rateTrip(trip.id);
        }

        async function cancelTrip(tripId) {
            if (!confirm('Bạn có chắc chắn muốn hủy chuyến đi này?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/trips/${tripId}/cancel`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${dcApp.token}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', 'Đã hủy chuyến đi thành công');
                    loadTrips(currentPage);
                    
                    // Close modal if open
                    const modal = bootstrap.Modal.getInstance(document.getElementById('tripDetailModal'));
                    if (modal) modal.hide();
                } else {
                    showAlert('error', result.message || 'Không thể hủy chuyến đi');
                }
            } catch (error) {
                console.error('Cancel trip error:', error);
                showAlert('error', 'Lỗi khi hủy chuyến đi');
            }
        }

        function rateTrip(tripId) {
            // Guard: only customers (khach_hang) who own the trip can rate
            if (!window.dcApp || !window.dcApp.user || window.dcApp.user.loai_tai_khoan !== 'khach_hang') {
                showAlert('warning', 'Chỉ khách hàng mới được đánh giá chuyến đi');
                return;
            }
            // Ensure the trip in current list belongs to the user (extra client-side safety)
            const tripCard = [...document.querySelectorAll('.card.shadow-sm.mb-3')]
                .find(el => el.innerHTML.includes(`#${tripId}`));
            // (Optional: could fetch trip detail to verify ownership here)
            document.getElementById('rating-trip-id').value = tripId;
            document.getElementById('driver-rating').value = '5';
            document.getElementById('review-comment').value = '';
            
            // Reset stars
            document.querySelectorAll('.star').forEach(star => {
                star.classList.remove('text-warning');
                star.classList.add('text-muted');
            });
            
            // Highlight first 5 stars
            for (let i = 1; i <= 5; i++) {
                document.querySelector(`[data-rating="${i}"]`).classList.remove('text-muted');
                document.querySelector(`[data-rating="${i}"]`).classList.add('text-warning');
            }

            const modal = new bootstrap.Modal(document.getElementById('ratingModal'));
            modal.show();
        }

        function setupRatingStars() {
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    document.getElementById('driver-rating').value = rating;
                    
                    // Update star display
                    document.querySelectorAll('.star').forEach(s => {
                        s.classList.remove('text-warning');
                        s.classList.add('text-muted');
                    });
                    
                    for (let i = 1; i <= rating; i++) {
                        document.querySelector(`[data-rating="${i}"]`).classList.remove('text-muted');
                        document.querySelector(`[data-rating="${i}"]`).classList.add('text-warning');
                    }
                });
            });
        }

        async function submitRating() {
            const tripId = document.getElementById('rating-trip-id').value;
            const rating = document.getElementById('driver-rating').value;
            const comment = document.getElementById('review-comment').value;

            try {
                const response = await fetch(`${API_BASE_URL}/reviews`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${dcApp.token}`
                    },
                    body: JSON.stringify({
                        chuyen_di_id: tripId,
                        diem_so: rating,
                        nhan_xet: comment
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', 'Cảm ơn bạn đã đánh giá!');
                    
                    const modal = bootstrap.Modal.getInstance(document.getElementById('ratingModal'));
                    modal.hide();
                    
                    loadTrips(currentPage);
                } else {
                    showAlert('error', result.message || 'Không thể gửi đánh giá');
                }
            } catch (error) {
                console.error('Submit rating error:', error);
                showAlert('error', 'Lỗi khi gửi đánh giá');
            }
        }
    </script>

    <style>
        /* Ensure footer stays at bottom when content is short */
        html, body {
            height: 100%;
        }
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .page-content {
            flex: 1 0 auto;
        }
        .rating-stars .star {
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .rating-stars .star:hover {
            color: #ffc107 !important;
        }
        
        .trip-route {
            position: relative;
        }
        
        .trip-route::before {
            content: '';
            position: absolute;
            left: 7px;
            top: 20px;
            bottom: 20px;
            width: 2px;
            background: linear-gradient(to bottom, #28a745, #dc3545);
        }
        
        .badge {
            font-size: 0.75rem;
        }

        /* Pagination button styles */
        .pagination {
            gap: 0.5rem;
            align-items: center;
        }

        .pagination .pagination-btn {
            border-radius: 999px;
            padding: .45rem .9rem;
            background: linear-gradient(135deg,#ffffff 0%, #f8f9ff 100%);
            border: 1px solid rgba(13,110,253,0.12);
            box-shadow: 0 2px 6px rgba(16,24,40,0.06);
            color: #0d6efd;
            transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
            display: inline-block;
        }

        .pagination .pagination-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(13,110,253,0.12);
            background: linear-gradient(135deg,#ffffff 0%, #e9f4ff 100%);
            text-decoration: none;
        }

        .pagination .page-item.active .pagination-btn {
            background: linear-gradient(90deg,#0d6efd 0%,#6610f2 100%);
            color: #fff !important;
            box-shadow: 0 10px 30px rgba(13,110,253,0.18);
            border-color: transparent;
        }

        .pagination .page-item.disabled .pagination-btn {
            opacity: 0.6;
            pointer-events: none;
            transform: none;
        }

        .pagination .pagination-btn:focus {
            outline: none;
            box-shadow: 0 0 0 6px rgba(13,110,253,0.08);
        }

        /* Clickable trip card styles */
        .trip-card-clickable {
            cursor: pointer;
            transition: transform .12s ease, box-shadow .12s ease;
        }
        .trip-card-clickable:focus,
        .trip-card-clickable:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(16,24,40,0.08);
        }
        .trip-card-clickable .actions .btn {
            pointer-events: auto; /* allow inner buttons to be clickable */
        }
    </style>

    <!-- Footer (copied from index.html) -->
    <footer class="bg-dark text-light py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5 class="text-white"><i class="fas fa-car"></i> DC Car Booking</h5>
                    <p class="text-light opacity-75">Hệ thống đặt xe trực tuyến hàng đầu Việt Nam</p>
                    <div class="mt-3">
                        <img src="/uploads/bocongthuong/Logo-thong-bao-mau-do-1.png" 
                             alt="Đã đăng ký Bộ Công Thương" 
                             style="height: 150px; object-fit: contain;"
                             onerror="this.style.display='none'">
                    </div>
                </div>
                <div class="col-md-4">
                    <h6 class="text-white mb-3">Liên hệ</h6>
                    <div class="text-light opacity-75">
                        <p class="mb-2"><i class="fas fa-phone"></i> Hotline: <a href="tel:19006789" class="text-light text-decoration-none">1900 6789</a></p>
                        <p class="mb-2"><i class="fas fa-envelope"></i> Email: <a href="mailto:support@dcbooking.com" class="text-light text-decoration-none">support@dcbooking.com</a></p>
                        <p class="mb-2"><i class="fab fa-facebook"></i> Facebook: <a href="https://web.facebook.com/manhcuonq204" target="_blank" class="text-light text-decoration-none">DC Booking</a></p>
                    </div>
                </div>
                <div class="col-md-4">
                    <h6 class="text-white mb-3">Địa chỉ</h6>
                    <p class="text-light opacity-75">
                        <i class="fas fa-map-marker-alt"></i> Trụ sở:<br>
                        HUTECH - Đại học Công nghệ TP.HCM (Thu Duc Campus)<br>
                        Khu Công nghệ cao XLHN, Hiệp Phú,<br>
                         Thủ Đức, Thành phố Hồ Chí Minh, Việt Nam
                    </p>
                </div>
            </div>
            <hr class="border-secondary my-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="text-light opacity-75 mb-0">© 2024 DC Car Booking. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>
</body>
</html>
