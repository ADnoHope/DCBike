<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tài xế - DC Car Booking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="fas fa-car me-2"></i>DC Car Booking
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">Trang chủ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="booking.html">Đặt xe</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="trips.html">Chuyến đi</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="drivers.html">Tài xế</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="promotions.html">Khuyến mãi</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown" id="user-menu" style="display: none;">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> <span id="user-name"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="profile.html">Hồ sơ</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">Đăng xuất</a></li>
                        </ul>
                    </li>
                    <li class="nav-item" id="auth-btn">
                        <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#authModal">
                            Đăng nhập
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-5">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h2><i class="fas fa-users me-2"></i>Danh sách tài xế</h2>
                <p class="text-muted">Tìm kiếm và lựa chọn tài xế phù hợp</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="../driver-registration.html" class="btn btn-success">
                    <i class="fas fa-user-plus me-2"></i>Đăng ký làm tài xế
                </a>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Loại xe</label>
                        <select class="form-select" id="car-type-filter">
                            <option value="">Tất cả loại xe</option>
                            <option value="4-cho">Xe 4 chỗ</option>
                            <option value="7-cho">Xe 7 chỗ</option>
                            <option value="16-cho">Xe 16 chỗ</option>
                            <option value="45-cho">Xe 45 chỗ</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Kinh nghiệm</label>
                        <select class="form-select" id="experience-filter">
                            <option value="">Tất cả</option>
                            <option value="1">Từ 1 năm</option>
                            <option value="3">Từ 3 năm</option>
                            <option value="5">Từ 5 năm</option>
                            <option value="10">Từ 10 năm</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Đánh giá</label>
                        <select class="form-select" id="rating-filter">
                            <option value="">Tất cả đánh giá</option>
                            <option value="4">Từ 4 sao trở lên</option>
                            <option value="4.5">Từ 4.5 sao trở lên</option>
                            <option value="4.8">Từ 4.8 sao trở lên</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-outline-primary me-2" onclick="applyFilters()">
                            <i class="fas fa-filter me-2"></i>Lọc
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="fas fa-times me-2"></i>Xóa
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" id="search-input" 
                           placeholder="Tìm kiếm tài xế theo tên, số điện thoại...">
                    <button class="btn btn-outline-secondary" onclick="searchDrivers()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Drivers Grid -->
        <div id="drivers-container">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Đang tải danh sách tài xế...</p>
            </div>
        </div>

        <!-- Pagination -->
        <nav aria-label="Drivers pagination" class="mt-4">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be generated here -->
            </ul>
        </nav>
    </div>

    <!-- Driver Detail Modal -->
    <div class="modal fade" id="driverDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thông tin tài xế</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="driver-detail-content">
                    <!-- Driver details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="book-driver-btn">
                        <i class="fas fa-car me-2"></i>Đặt xe với tài xế này
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alert-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Check if API_BASE_URL is already defined
        const API_BASE_URL = 'http://localhost:3000/api';
        
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {};

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize user authentication
            checkAuth();
            loadDrivers();
            
            // Setup search on Enter key
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchDrivers();
                    }
                });
            } else {
                console.error('Search input not found');
            }
        });

        // Authentication functions
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (token) {
                // Update UI for logged in user
                fetch(`${API_BASE_URL}/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        updateUIForUser(result.data);
                    } else {
                        // Token invalid, clear it
                        localStorage.removeItem('token');
                        updateUIForGuest();
                    }
                })
                .catch(error => {
                    console.error('Auth check error:', error);
                    updateUIForGuest();
                });
            } else {
                updateUIForGuest();
            }
        }

        function updateUIForUser(user) {
            const userMenu = document.getElementById('user-menu');
            const authBtn = document.getElementById('auth-btn');
            const userName = document.getElementById('user-name');
            
            if (userMenu && authBtn && userName) {
                userName.textContent = user.ten;
                userMenu.style.display = 'block';
                authBtn.style.display = 'none';
            }
        }

        function updateUIForGuest() {
            const userMenu = document.getElementById('user-menu');
            const authBtn = document.getElementById('auth-btn');
            
            if (userMenu && authBtn) {
                userMenu.style.display = 'none';
                authBtn.style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.reload();
        }

        // Alert function
        function showAlert(type, message) {
            const alertContainer = document.getElementById('alert-container');
            if (!alertContainer) return;
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            alertContainer.appendChild(alertDiv);
            
            // Auto dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        async function loadDrivers(page = 1) {
            try {
                const response = await fetch(`${API_BASE_URL}/drivers/available`, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                const result = await response.json();

                if (result.success) {
                    displayDrivers(result.data);
                    setupSimplePagination(result.data.length);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Load drivers error:', error);
                document.getElementById('drivers-container').innerHTML = `
                    <div class="text-center">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Lỗi khi tải danh sách tài xế: ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        function displayDrivers(drivers) {
            const container = document.getElementById('drivers-container');
            
            if (!drivers || drivers.length === 0) {
                container.innerHTML = `
                    <div class="text-center">
                        <div class="card shadow-sm">
                            <div class="card-body py-5">
                                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                <h5>Không tìm thấy tài xế nào</h5>
                                <p class="text-muted">Hiện tại chưa có tài xế nào đang hoạt động trong hệ thống.</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            let html = '<div class="row">';
            drivers.forEach((driver, index) => {
                const rating = generateRandomRating();
                const trips = Math.floor(Math.random() * 500) + 50;
                const experience = driver.kinh_nghiem_lien_tuc || Math.floor(Math.random() * 10) + 1;

                html += `
                    <div class="col-lg-4 col-md-6 mb-4">
                        <div class="card h-100 shadow-sm driver-card">
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    <div class="driver-avatar mb-2">
                                        <i class="fas fa-user-circle fa-4x text-primary"></i>
                                    </div>
                                    <h5 class="card-title mb-1">${driver.ten || 'N/A'}</h5>
                                    <div class="rating mb-2">
                                        ${generateStars(rating)} 
                                        <span class="text-muted">(${trips} chuyến)</span>
                                    </div>
                                </div>
                                
                                <div class="driver-info">
                                    <div class="info-item mb-2">
                                        <i class="fas fa-car text-primary me-2"></i>
                                        <strong>${driver.loai_xe || 'N/A'}</strong> - ${driver.so_cho_ngoi || 'N/A'} chỗ
                                    </div>
                                    <div class="info-item mb-2">
                                        <i class="fas fa-palette text-info me-2"></i>
                                        ${driver.hang_xe || 'N/A'} ${driver.mau_xe || ''}
                                    </div>
                                    <div class="info-item mb-2">
                                        <i class="fas fa-id-card text-success me-2"></i>
                                        Bằng lái ${driver.loai_bang_lai || 'N/A'}
                                    </div>
                                    <div class="info-item mb-2">
                                        <i class="fas fa-clock text-warning me-2"></i>
                                        ${experience} năm kinh nghiệm
                                    </div>
                                    <div class="info-item mb-2">
                                        <i class="fas fa-phone text-secondary me-2"></i>
                                        ${driver.so_dien_thoai || 'N/A'}
                                    </div>
                                </div>
                                
                                <div class="status-badges mt-3 mb-3">
                                    <span class="badge bg-success">Đang hoạt động</span>
                                    <span class="badge bg-info">Xe sạch sẽ</span>
                                    ${rating >= 4.5 ? '<span class="badge bg-warning text-dark">Tài xế xuất sắc</span>' : ''}
                                </div>
                            </div>
                            
                            <div class="card-footer bg-transparent">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary" onclick="viewDriverDetail(${driver.id || driver.tai_xe_id})">
                                        <i class="fas fa-eye me-2"></i>Xem chi tiết
                                    </button>
                                    <button class="btn btn-primary" onclick="bookWithDriver(${driver.id || driver.tai_xe_id})">
                                        <i class="fas fa-car me-2"></i>Đặt xe ngay
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        function generateRandomRating() {
            return (Math.random() * 1.5 + 3.5).toFixed(1);
        }

        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let html = '';
            
            for (let i = 0; i < fullStars; i++) {
                html += '<i class="fas fa-star text-warning"></i>';
            }
            
            if (hasHalfStar) {
                html += '<i class="fas fa-star-half-alt text-warning"></i>';
            }
            
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            for (let i = 0; i < emptyStars; i++) {
                html += '<i class="far fa-star text-warning"></i>';
            }
            
            html += ` <span class="ms-1"><strong>${rating}</strong></span>`;
            return html;
        }

        function setupPagination(pagination) {
            totalPages = pagination.totalPages;
            currentPage = pagination.currentPage;
            
            const paginationContainer = document.getElementById('pagination');
            let html = '';

            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            // Previous button
            html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadDrivers(${currentPage - 1})">Trước</a>
                </li>
            `;

            // Page numbers
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadDrivers(${i})">${i}</a>
                    </li>
                `;
            }

            // Next button
            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadDrivers(${currentPage + 1})">Sau</a>
                </li>
            `;

            paginationContainer.innerHTML = html;
        }

        function setupSimplePagination(driverCount) {
            const paginationContainer = document.getElementById('pagination');
            // Simple pagination for available drivers - just show count
            paginationContainer.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-users me-2"></i>
                    Hiển thị ${driverCount} tài xế có sẵn
                </div>
            `;
        }

        function applyFilters() {
            currentFilters = {
                car_type: document.getElementById('car-type-filter').value,
                min_experience: document.getElementById('experience-filter').value,
                min_rating: document.getElementById('rating-filter').value
            };

            // Remove empty filters
            Object.keys(currentFilters).forEach(key => {
                if (!currentFilters[key]) {
                    delete currentFilters[key];
                }
            });

            loadDrivers(1);
        }

        function clearFilters() {
            document.getElementById('car-type-filter').value = '';
            document.getElementById('experience-filter').value = '';
            document.getElementById('rating-filter').value = '';
            document.getElementById('search-input').value = '';
            currentFilters = {};
            loadDrivers(1);
        }

        function searchDrivers() {
            const searchTerm = document.getElementById('search-input').value.trim();
            if (searchTerm) {
                currentFilters.search = searchTerm;
            } else {
                delete currentFilters.search;
            }
            loadDrivers(1);
        }

        async function viewDriverDetail(driverId) {
            try {
                const response = await fetch(`${API_BASE_URL}/drivers/${driverId}`);
                const result = await response.json();

                if (result.success) {
                    displayDriverDetail(result.data);
                    const modal = new bootstrap.Modal(document.getElementById('driverDetailModal'));
                    modal.show();
                } else {
                    showAlert('error', 'Không thể tải thông tin tài xế');
                }
            } catch (error) {
                console.error('Load driver detail error:', error);
                showAlert('error', 'Lỗi khi tải thông tin tài xế');
            }
        }

        function displayDriverDetail(driver) {
            const rating = generateRandomRating();
            const trips = Math.floor(Math.random() * 500) + 50;
            const experience = driver.kinh_nghiem_lien_tuc || Math.floor(Math.random() * 10) + 1;

            const content = `
                <div class="row">
                    <div class="col-md-4 text-center">
                        <i class="fas fa-user-circle fa-5x text-primary mb-3"></i>
                        <h4>${driver.ten}</h4>
                        <div class="rating mb-3">
                            ${generateStars(rating)}
                        </div>
                        <div class="stats">
                            <div class="stat-item mb-2">
                                <strong>${trips}</strong> chuyến đi
                            </div>
                            <div class="stat-item mb-2">
                                <strong>${experience}</strong> năm kinh nghiệm
                            </div>
                            <div class="stat-item">
                                <span class="badge bg-success">Đang hoạt động</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Thông tin cá nhân</h6>
                                <table class="table table-borderless table-sm">
                                    <tr><td><i class="fas fa-phone me-2"></i>Điện thoại:</td><td>${driver.so_dien_thoai}</td></tr>
                                    <tr><td><i class="fas fa-envelope me-2"></i>Email:</td><td>${driver.email}</td></tr>
                                    <tr><td><i class="fas fa-map-marker-alt me-2"></i>Địa chỉ:</td><td>${driver.dia_chi || 'Chưa cập nhật'}</td></tr>
                                </table>
                                
                                <h6 class="mt-3">Bằng lái xe</h6>
                                <table class="table table-borderless table-sm">
                                    <tr><td><i class="fas fa-id-card me-2"></i>Số bằng lái:</td><td>${driver.so_bang_lai}</td></tr>
                                    <tr><td><i class="fas fa-certificate me-2"></i>Loại bằng lái:</td><td>${driver.loai_bang_lai}</td></tr>
                                    <tr><td><i class="fas fa-clock me-2"></i>Kinh nghiệm:</td><td>${experience} năm</td></tr>
                                </table>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>Thông tin xe</h6>
                                <table class="table table-borderless table-sm">
                                    <tr><td><i class="fas fa-car me-2"></i>Loại xe:</td><td>${driver.loai_xe}</td></tr>
                                    <tr><td><i class="fas fa-hashtag me-2"></i>Biển số:</td><td><strong>${driver.bien_so_xe}</strong></td></tr>
                                    <tr><td><i class="fas fa-industry me-2"></i>Hãng xe:</td><td>${driver.hang_xe}</td></tr>
                                    <tr><td><i class="fas fa-palette me-2"></i>Màu sắc:</td><td>${driver.mau_xe}</td></tr>
                                    <tr><td><i class="fas fa-users me-2"></i>Số chỗ ngồi:</td><td>${driver.so_cho_ngoi} chỗ</td></tr>
                                </table>
                                
                                <h6 class="mt-3">Đánh giá gần đây</h6>
                                <div class="reviews">
                                    <div class="review-item mb-2 p-2 bg-light rounded">
                                        <div class="d-flex justify-content-between">
                                            <small><strong>Khách hàng A</strong></small>
                                            <small class="text-warning">⭐⭐⭐⭐⭐</small>
                                        </div>
                                        <small class="text-muted">Tài xế lái xe an toàn, thái độ phục vụ tốt!</small>
                                    </div>
                                    <div class="review-item mb-2 p-2 bg-light rounded">
                                        <div class="d-flex justify-content-between">
                                            <small><strong>Khách hàng B</strong></small>
                                            <small class="text-warning">⭐⭐⭐⭐⭐</small>
                                        </div>
                                        <small class="text-muted">Xe sạch sẽ, đúng giờ. Rất hài lòng!</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('driver-detail-content').innerHTML = content;
            document.getElementById('book-driver-btn').onclick = () => bookWithDriver(driver.id);
        }

        function bookWithDriver(driverId) {
            // Close modal if open
            const modal = bootstrap.Modal.getInstance(document.getElementById('driverDetailModal'));
            if (modal) modal.hide();
            
            // Redirect to booking page with driver pre-selected
            window.location.href = `booking.html?driver=${driverId}`;
        }
    </script>

    <style>
        .driver-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .driver-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
        }
        
        .driver-avatar {
            transition: color 0.2s;
        }
        
        .driver-card:hover .driver-avatar i {
            color: var(--primary) !important;
        }
        
        .info-item {
            font-size: 0.9rem;
        }
        
        .status-badges .badge {
            font-size: 0.7rem;
            margin-right: 0.25rem;
        }
        
        .rating .fa-star,
        .rating .fa-star-half-alt {
            font-size: 0.9rem;
        }
        
        .review-item {
            border-left: 3px solid var(--primary);
        }
        
        .stat-item {
            font-size: 0.9rem;
        }
    </style>
</body>
</html>
