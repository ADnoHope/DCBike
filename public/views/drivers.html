<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tài xế - DC Booking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <button class="btn btn-link text-white p-0 me-3" id="sidebar-toggle" type="button">
                <i class="fas fa-bars fa-lg"></i>
            </button>
            <a class="navbar-brand fw-bold" href="../index.html">
                <i class="fas fa-car"></i> DC Booking
            </a>
            <div class="ms-auto" id="auth-nav">
                <a class="btn btn-link text-white text-decoration-none" href="#" onclick="showAuthModal()">Đăng nhập</a>
            </div>
            <div class="ms-auto d-none" id="user-nav">
                <div class="dropdown">
                    <a class="btn btn-link text-white text-decoration-none dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <span id="user-name"></span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="profile.html"><i class="fas fa-user me-2"></i>Hồ sơ cá nhân</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Đăng xuất</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar Menu -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <div class="sidebar-menu" id="sidebar-menu">
        <div class="sidebar-header">
            <h5 class="mb-0"><i class="fas fa-car"></i> Menu</h5>
            <button class="btn-close btn-close-white" id="sidebar-close"></button>
        </div>
        <div class="sidebar-body">
            <!-- Status Toggle (driver) -->
            <div class="status-toggle-container mb-3">
                <div class="status-toggle" id="status-container">
                    <div>
                        <h6 class="mb-0" id="status-title">
                            <i class="fas fa-circle me-2" id="status-icon"></i>
                            <span id="status-text">Đang tải...</span>
                        </h6>
                        <small class="text-muted" id="status-description">Đang kiểm tra trạng thái</small>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="statusToggle" onchange="toggleDriverStatus()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="mt-2 text-center" id="status-info">
                    <small class="text-muted">Bật để nhận chuyến đi mới</small>
                </div>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item d-none" id="home-nav-sidebar">
                    <a class="nav-link" href="../index.html"><i class="fas fa-home me-2"></i>Trang chủ</a>
                </li>
                <li class="nav-item d-none" id="booking-nav-sidebar">
                    <a class="nav-link" href="booking.html" data-auth><i class="fas fa-calendar-check me-2"></i>Đặt xe</a>
                </li>
                <li class="nav-item d-none" id="trips-nav-sidebar">
                    <a class="nav-link" href="trips.html" data-auth><i class="fas fa-route me-2"></i>Chuyến đi</a>
                </li>
                <li class="nav-item d-none" id="drivers-nav-sidebar">
                    <a class="nav-link" href="drivers.html"><i class="fas fa-user-tie me-2"></i>Tài xế</a>
                </li>
                <li class="nav-item d-none" id="stats-menu-item-sidebar">
                    <a class="nav-link" href="driver-dashboard.html"><i class="fas fa-chart-bar me-2"></i>Thống kê</a>
                </li>
                <li class="nav-item d-none" id="promotions-nav-sidebar">
                    <a class="nav-link" href="promotions.html"><i class="fas fa-gift me-2"></i>Khuyến mãi</a>
                </li>
                <li class="nav-item d-none" id="driverreg-nav-sidebar">
                    <a class="nav-link" href="../driver-registration.html"><i class="fas fa-user-plus me-2"></i>Đăng ký tài xế</a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container my-5">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h2 class="text-dark fw-bold"><i class="fas fa-users me-2"></i>Danh sách tài xế</h2>
                <p class="text-secondary">Tìm kiếm và lựa chọn tài xế phù hợp</p>
            </div>
            <div class="col-md-4 text-end">
                <a id="driver-register-btn" href="../driver-registration.html" class="btn btn-success">
                    <i class="fas fa-user-plus me-2"></i>Đăng ký làm tài xế
                </a>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label text-dark fw-semibold">Loại xe</label>
                        <select class="form-select" id="car-type-filter">
                            <option value="">Tất cả loại xe</option>
                            <option value="4-cho">Xe 4 chỗ</option>
                            <option value="7-cho">Xe 7 chỗ</option>
                            <option value="16-cho">Xe 16 chỗ</option>
                            <option value="45-cho">Xe 45 chỗ</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-dark fw-semibold">Kinh nghiệm</label>
                        <select class="form-select" id="experience-filter">
                            <option value="">Tất cả</option>
                            <option value="1">Từ 1 năm</option>
                            <option value="3">Từ 3 năm</option>
                            <option value="5">Từ 5 năm</option>
                            <option value="10">Từ 10 năm</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-dark fw-semibold">Đánh giá</label>
                        <select class="form-select" id="rating-filter">
                            <option value="">Tất cả đánh giá</option>
                            <option value="4">Từ 4 sao trở lên</option>
                            <option value="4.5">Từ 4.5 sao trở lên</option>
                            <option value="4.8">Từ 4.8 sao trở lên</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-outline-primary me-2" onclick="applyFilters()">
                            <i class="fas fa-filter me-2"></i>Lọc
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="fas fa-times me-2"></i>Xóa
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" id="search-input" 
                           placeholder="Tìm kiếm tài xế theo tên, số điện thoại...">
                    <button class="btn btn-outline-secondary" onclick="searchDrivers()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Drivers Grid -->
        <div id="drivers-container">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Đang tải danh sách tài xế...</p>
            </div>
        </div>

        <!-- Pagination -->
        <nav aria-label="Drivers pagination" class="mt-4">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be generated here -->
            </ul>
        </nav>
    </div>

    <!-- Driver Detail Modal -->
    <div class="modal fade" id="driverDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thông tin tài xế</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="driver-detail-content">
                    <!-- Driver details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-success" id="contact-driver-btn" data-auth data-auth-roles="khach_hang">
                        <i class="fas fa-comments me-2"></i>Liên lạc với tài xế
                    </button>
                    <button type="button" class="btn btn-primary" id="book-driver-btn" data-auth data-auth-roles="khach_hang">
                        <i class="fas fa-car me-2"></i>Đặt xe với tài xế này
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alert-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>

    <!-- Auth Modal -->
    <div class="modal fade" id="authModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content auth-modal-content">
                <div class="modal-header border-0 pb-0">
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body px-4 pb-4">
                    <!-- Auth Header -->
                    <div class="text-center mb-4">
                        <div class="auth-icon-wrapper mb-3">
                            <i class="fas fa-user-circle fa-4x text-primary"></i>
                        </div>
                        <h4 class="fw-bold mb-1" id="authModalTitle">Đăng nhập</h4>
                        <p class="text-muted small" id="authModalSubtitle">Chào mừng bạn quay trở lại</p>
                    </div>

                    <!-- Login Form -->
                    <form id="login-form" class="auth-form">
                        <div class="mb-3">
                            <label class="form-label small fw-semibold text-dark">Email hoặc Số điện thoại</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-user text-muted"></i>
                                </span>
                                <input type="text" class="form-control border-start-0 ps-0" id="login-identifier" 
                                       placeholder="Nhập email hoặc số điện thoại" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-semibold text-dark">Mật khẩu</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-lock text-muted"></i>
                                </span>
                                <input type="password" class="form-control border-start-0 ps-0" id="login-password" 
                                       placeholder="Nhập mật khẩu" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 py-2 fw-semibold mb-2">
                            <i class="fas fa-sign-in-alt me-2"></i>Đăng nhập
                        </button>
                    </form>

                    <!-- Register Form -->
                    <form id="register-form" class="auth-form d-none">
                        <div class="mb-3">
                            <label class="form-label small fw-semibold text-dark">Họ và tên</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-id-card text-muted"></i>
                                </span>
                                <input type="text" class="form-control border-start-0 ps-0" id="register-name" 
                                       placeholder="Nhập họ và tên" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-semibold text-dark">Vai trò</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-user-tag text-muted"></i>
                                </span>
                                <select class="form-select border-start-0 ps-0" id="register-role" required>
                                    <option value="khach_hang">Người dùng</option>
                                    <option value="tai_xe">Tài xế</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-semibold text-dark">Email</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-envelope text-muted"></i>
                                </span>
                                <input type="email" class="form-control border-start-0 ps-0" id="register-email" 
                                       placeholder="Nhập địa chỉ email" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-semibold text-dark">Số điện thoại</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-phone text-muted"></i>
                                </span>
                                <input type="tel" class="form-control border-start-0 ps-0" id="register-phone" 
                                       placeholder="Nhập số điện thoại" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-semibold text-dark">Mật khẩu</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-lock text-muted"></i>
                                </span>
                                <input type="password" class="form-control border-start-0 ps-0" id="register-password" 
                                       placeholder="Nhập mật khẩu" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-semibold text-dark">Xác nhận mật khẩu</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-lock text-muted"></i>
                                </span>
                                <input type="password" class="form-control border-start-0 ps-0" id="register-confirm-password" 
                                       placeholder="Nhập lại mật khẩu" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 py-2 fw-semibold mb-2">
                            <i class="fas fa-user-plus me-2"></i>Đăng ký
                        </button>
                    </form>

                    <!-- Divider -->
                    <div class="text-center my-3">
                        <hr class="my-3">
                    </div>

                    <!-- Switch Form Link -->
                    <div class="text-center">
                        <p class="mb-0 text-muted small">
                            <span id="auth-switch-text">Chưa có tài khoản?</span>
                            <a href="#" id="auth-switch-link" onclick="toggleAuthForm()" class="text-primary fw-semibold text-decoration-none">Đăng ký ngay</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/notifications.js"></script>
    <script src="/js/app.js"></script>
    <script>
        async function loadDriverStatus() {
            try { const token = localStorage.getItem('token'); if(!token) return; const res = await fetch(`${window.API_BASE_URL}/drivers/my-status`, { headers: { 'Authorization': `Bearer ${token}` } }); const data = await res.json(); if (data && data.success && data.data) updateStatusUI(data.data.trang_thai_tai_xe); } catch (e) { console.debug(e); }
        }
        function updateStatusUI(status) {
            const container = document.getElementById('status-container'); const toggle = document.getElementById('statusToggle'); const icon = document.getElementById('status-icon'); const text = document.getElementById('status-text'); const description = document.getElementById('status-description'); if (!container||!toggle) return; if (status==='san_sang') { container.classList.add('active'); container.classList.remove('inactive'); toggle.checked=true; icon.className='fas fa-circle me-2'; text.textContent='Đang hoạt động'; description.textContent='Bạn có thể nhận chuyến đi mới'; } else { container.classList.remove('active'); container.classList.add('inactive'); toggle.checked=false; icon.className='fas fa-moon me-2'; text.textContent='Không hoạt động'; description.textContent='Bật để bắt đầu nhận chuyến'; }
        }
        async function toggleDriverStatus() { const toggle=document.getElementById('statusToggle'); if(!toggle) return; const newStatus = toggle.checked ? 'san_sang' : 'nghi_lam'; try { const token = localStorage.getItem('token'); const res = await fetch(`${window.API_BASE_URL}/drivers/status`, { method:'POST', headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${token}` }, body: JSON.stringify({ trang_thai: newStatus }) }); const data = await res.json(); if (data && data.success) { updateStatusUI(newStatus); showNotification(toggle.checked ? 'Đã bật trạng thái hoạt động' : 'Đã tắt trạng thái hoạt động','success'); } else { toggle.checked = !toggle.checked; showNotification('Không thể thay đổi trạng thái','error'); } } catch (e) { console.error(e); toggle.checked = !toggle.checked; showNotification('Lỗi khi thay đổi trạng thái','error'); } }
        document.addEventListener('DOMContentLoaded', () => setTimeout(loadDriverStatus, 600));
    </script>
    <script>
        console.log('drivers.html script started');
        
        // Global variables - NO API_BASE_URL declaration, use window.API_BASE_URL directly
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {};

        document.addEventListener('DOMContentLoaded', function() {
            console.log('[DRIVERS] DOMContentLoaded fired');
            console.log('[DRIVERS] window.API_BASE_URL:', window.API_BASE_URL);
            
            // Check if container exists
            const container = document.getElementById('drivers-container');
            console.log('[DRIVERS] Container found:', !!container);
            
            // Simple approach - just call loadDrivers after a short delay
            setTimeout(() => {
                console.log('[DRIVERS] Calling loadDrivers()...');
                loadDrivers();
                
                // Temporarily disable notification polling to avoid 403 errors during debug
                /*
                // If the logged-in user is a driver, start polling for notifications
                if (window.dcApp && window.dcApp.user && window.dcApp.user.loai_tai_khoan === 'tai_xe') {
                    startNotificationPolling();
                }
                */
            }, 500);
            
            // Setup search on Enter key
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchDrivers();
                    }
                });
            } else {
                console.error('Search input not found');
            }
        });

        function logout() {
            if (window.dcApp && typeof window.dcApp.logout === 'function') {
                window.dcApp.logout();
            } else {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/index.html';
            }
        }

        async function loadDrivers(page = 1) {
            console.log('[DRIVERS] loadDrivers() called, page:', page);
            console.log('[DRIVERS] window.API_BASE_URL:', window.API_BASE_URL);
            
            try {
                const apiUrl = window.API_BASE_URL || 'http://localhost:3000/api';
                const endpoint = `${apiUrl}/drivers/available`;
                
                console.log('[DRIVERS] Fetching from:', endpoint);
                
                const response = await fetch(endpoint, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                console.log('[DRIVERS] Response status:', response.status);
                const result = await response.json();
                console.log('[DRIVERS] API Response:', result);
                console.log('[DRIVERS] First driver full data:', result.data && result.data[0] ? JSON.stringify(result.data[0], null, 2) : 'No data');

                if (result.success) {
                    console.log('[DRIVERS] Drivers data length:', result.data.length);
                    displayDrivers(result.data);
                    setupSimplePagination(result.data.length);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('[DRIVERS] Load error:', error);
                document.getElementById('drivers-container').innerHTML = `
                    <div class="text-center">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Lỗi khi tải danh sách tài xế: ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        function displayDrivers(drivers) {
            console.log('displayDrivers called with:', drivers); // Debug log
            console.log('Number of drivers:', drivers ? drivers.length : 0); // Debug log
            
            const container = document.getElementById('drivers-container');
            console.log('Container element:', container); // Debug log
            
            if (!container) {
                console.error('drivers-container element not found!');
                return;
            }
            
            if (!drivers || drivers.length === 0) {
                container.innerHTML = `
                    <div class="text-center">
                        <div class="card shadow-sm">
                            <div class="card-body py-5">
                                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                <h5>Không tìm thấy tài xế nào</h5>
                                <p class="text-muted">Hiện tại chưa có tài xế nào đang hoạt động trong hệ thống.</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            let html = '<div class="row">';
            drivers.forEach((driver, index) => {
                try {
                    const rating = Number(driver.diem_danh_gia || 0).toFixed(1);
                    const trips = Number(driver.so_chuyen_di || 0);
                    const experience = driver.kinh_nghiem_lien_tuc || 0;
                    
                    // Debug: Log driver data to see avatar field
                    console.log('[DRIVERS] Driver data:', {
                        ten: driver.ten,
                        anh_dai_dien: driver.anh_dai_dien,
                        avatar: driver.avatar,
                        allFields: Object.keys(driver)
                    });
                    
                    // Try multiple possible avatar field names
                    let avatarUrl = null;
                    if (driver.anh_dai_dien) {
                        avatarUrl = driver.anh_dai_dien.startsWith('http') ? driver.anh_dai_dien : `http://localhost:3000${driver.anh_dai_dien}`;
                    } else if (driver.avatar) {
                        avatarUrl = driver.avatar.startsWith('http') ? driver.avatar : `http://localhost:3000${driver.avatar}`;
                    }
                    
                    console.log('[DRIVERS] Final avatar URL:', avatarUrl);

                    html += `
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card h-100 shadow-sm driver-card" style="cursor: pointer;" onclick="viewDriverDetail(${driver.id || driver.tai_xe_id})">
                                <div class="card-body">
                                    <div class="text-center mb-3">
                                        <div class="driver-avatar mb-2">
                                            ${avatarUrl ? 
                                                `<img src="${avatarUrl}" alt="${driver.ten}" class="rounded-circle" style="width: 80px; height: 80px; object-fit: cover; border: 3px solid #0d6efd;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                                                 <i class="fas fa-user-circle fa-4x text-primary" style="display: none;"></i>` 
                                                : 
                                                `<i class="fas fa-user-circle fa-4x text-primary"></i>`
                                            }
                                        </div>
                                        <h5 class="card-title mb-1 text-dark">${driver.ten || 'N/A'}</h5>
                                        <div class="rating mb-2">
                                            ${generateStars(rating)} 
                                            <span class="text-muted">(${trips} chuyến)</span>
                                        </div>
                                    </div>
                                    
                                    <div class="driver-info">
                                        <div class="info-item mb-2">
                                            <i class="fas fa-car text-primary me-2"></i>
                                            <strong>${driver.loai_xe || 'N/A'}</strong> - ${driver.so_cho_ngoi || 'N/A'} chỗ
                                        </div>
                                        <div class="info-item mb-2">
                                            <i class="fas fa-palette text-info me-2"></i>
                                            ${driver.hang_xe || 'N/A'} ${driver.mau_xe || ''}
                                        </div>
                                        <div class="info-item mb-2">
                                            <i class="fas fa-id-card text-success me-2"></i>
                                            Bằng lái ${driver.loai_bang_lai || 'N/A'}
                                        </div>
                                        
                                        <div class="info-item mb-2">
                                            <i class="fas fa-phone text-secondary me-2"></i>
                                            ${driver.so_dien_thoai || 'N/A'}
                                        </div>
                                    </div>
                                    
                                    <div class="status-badges mt-3 mb-3">
                                        ${driver.trang_thai_tai_xe === 'san_sang' ? '<span class="badge bg-success"><i class="fas fa-circle me-1"></i>Đang hoạt động</span>' : ''}
                                        ${driver.trang_thai_tai_xe === 'nghi_lam' ? '<span class="badge bg-secondary"><i class="fas fa-moon me-1"></i>Không hoạt động</span>' : ''}
                                        ${driver.trang_thai_tai_xe === 'dang_di' ? '<span class="badge bg-primary"><i class="fas fa-car me-1"></i>Đang trong chuyến</span>' : ''}
                                        <span class="badge bg-info">Xe sạch sẽ</span>
                                        ${rating >= 4.5 ? '<span class="badge bg-warning text-dark">Tài xế xuất sắc</span>' : ''}
                                    </div>
                                </div>
                                
                                <div class="card-footer bg-transparent">
                                    <div class="d-grid">
                                        <button class="btn btn-primary book-now-btn" data-auth data-auth-roles="khach_hang" onclick="event.stopPropagation(); bookWithDriver(${driver.id || driver.tai_xe_id})">
                                            <i class="fas fa-car me-2"></i>Đặt xe ngay
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (err) {
                    console.error('[DRIVERS] Error processing driver:', driver, err);
                }
            });
            html += '</div>';
            
            console.log('[DRIVERS] Final HTML length:', html.length);
            console.log('[DRIVERS] Setting innerHTML...');
            container.innerHTML = html;
            console.log('[DRIVERS] innerHTML set successfully');
        }

        // rating now comes from database (diem_danh_gia)

        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let html = '';
            
            for (let i = 0; i < fullStars; i++) {
                html += '<i class="fas fa-star text-warning"></i>';
            }
            
            if (hasHalfStar) {
                html += '<i class="fas fa-star-half-alt text-warning"></i>';
            }
            
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            for (let i = 0; i < emptyStars; i++) {
                html += '<i class="far fa-star text-warning"></i>';
            }
            
            html += ` <span class="ms-1"><strong>${rating}</strong></span>`;
            return html;
        }

        function setupPagination(pagination) {
            totalPages = pagination.totalPages;
            currentPage = pagination.currentPage;
            
            const paginationContainer = document.getElementById('pagination');
            let html = '';

            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            // Previous button
            html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadDrivers(${currentPage - 1})">Trước</a>
                </li>
            `;

            // Page numbers
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadDrivers(${i})">${i}</a>
                    </li>
                `;
            }

            // Next button
            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadDrivers(${currentPage + 1})">Sau</a>
                </li>
            `;

            paginationContainer.innerHTML = html;
        }

        function setupSimplePagination(driverCount) {
            const paginationContainer = document.getElementById('pagination');
            // Simple pagination for available drivers - just show count
            paginationContainer.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-users me-2"></i>
                    Hiển thị ${driverCount} tài xế có sẵn
                </div>
            `;
        }

        function applyFilters() {
            currentFilters = {
                car_type: document.getElementById('car-type-filter').value,
                min_experience: document.getElementById('experience-filter').value,
                min_rating: document.getElementById('rating-filter').value
            };

            // Remove empty filters
            Object.keys(currentFilters).forEach(key => {
                if (!currentFilters[key]) {
                    delete currentFilters[key];
                }
            });

            loadDrivers(1);
        }

        function clearFilters() {
            document.getElementById('car-type-filter').value = '';
            document.getElementById('experience-filter').value = '';
            document.getElementById('rating-filter').value = '';
            document.getElementById('search-input').value = '';
            currentFilters = {};
            loadDrivers(1);
        }

        function searchDrivers() {
            const searchTerm = document.getElementById('search-input').value.trim();
            if (searchTerm) {
                currentFilters.search = searchTerm;
            } else {
                delete currentFilters.search;
            }
            loadDrivers(1);
        }

        async function viewDriverDetail(driverId) {
            try {
                // Use public driver info endpoint so non-admin users can view details
                const response = await fetch(`${window.API_BASE_URL}/drivers/public/${driverId}`);
                const result = await response.json();
                
                console.log('[DRIVER DETAIL] API Response:', result);
                console.log('[DRIVER DETAIL] Full driver data:', JSON.stringify(result.data, null, 2));

                if (result.success) {
                        // driver data may already include so_chuyen_di after backend update
                        displayDriverDetail(result.data);
                    const modal = new bootstrap.Modal(document.getElementById('driverDetailModal'));
                    modal.show();
                } else {
                    showError('Không thể tải thông tin tài xế');
                }
            } catch (error) {
                console.error('Load driver detail error:', error);
                showError('Lỗi khi tải thông tin tài xế');
            }
        }

        function displayDriverDetail(driver) {
                const rating = Number(driver.diem_danh_gia || 0).toFixed(1);
                const trips = Number(driver.so_chuyen_di || 0);
                const experience = driver.kinh_nghiem_lien_tuc || 0;
                const reviewCount = Number(driver.so_luot_danh_gia || 0);
                
                // Debug: Log driver detail data
                console.log('[DRIVER DETAIL] Driver data:', {
                    ten: driver.ten,
                    anh_dai_dien: driver.anh_dai_dien,
                    avatar: driver.avatar,
                    allFields: Object.keys(driver)
                });
                
                // Try multiple possible avatar field names
                let avatarUrl = null;
                if (driver.anh_dai_dien) {
                    avatarUrl = driver.anh_dai_dien.startsWith('http') ? driver.anh_dai_dien : `http://localhost:3000${driver.anh_dai_dien}`;
                } else if (driver.avatar) {
                    avatarUrl = driver.avatar.startsWith('http') ? driver.avatar : `http://localhost:3000${driver.avatar}`;
                }
                
                console.log('[DRIVER DETAIL] Final avatar URL:', avatarUrl);

            const content = `
                <div class="row">
                    <div class="col-md-4 text-center">
                        <div class="mb-3">
                            ${avatarUrl ? 
                                `<img src="${avatarUrl}" alt="${driver.ten}" class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover; border: 4px solid #0d6efd;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                                 <i class="fas fa-user-circle fa-5x text-primary" style="display: none;"></i>` 
                                : 
                                `<i class="fas fa-user-circle fa-5x text-primary"></i>`
                            }
                        </div>
                        <h4>${driver.ten}</h4>
                        <div class="rating mb-1">
                            ${generateStars(rating)}
                        </div>
                        <div class="small text-muted mb-3">Đánh giá: ${rating} ★ (${reviewCount} lượt)</div>
                        <div class="stats">
                            <div class="stat-item mb-2">
                                <strong>${trips}</strong> chuyến đi đã hoàn thành
                            </div>
                            
                            <div class="stat-item">
                                ${driver.trang_thai_tai_xe === 'san_sang' ? '<span class="badge bg-success"><i class="fas fa-circle me-1"></i>Đang hoạt động</span>' : ''}
                                ${driver.trang_thai_tai_xe === 'nghi_lam' ? '<span class="badge bg-secondary"><i class="fas fa-moon me-1"></i>Không hoạt động</span>' : ''}
                                ${driver.trang_thai_tai_xe === 'dang_di' ? '<span class="badge bg-primary"><i class="fas fa-car me-1"></i>Đang trong chuyến</span>' : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Thông tin cá nhân</h6>
                                <table class="table table-borderless table-sm">
                                    <tr><td><i class="fas fa-phone me-2"></i>Điện thoại:</td><td>${driver.so_dien_thoai}</td></tr>
                                    <tr><td><i class="fas fa-envelope me-2"></i>Email:</td><td>${driver.email}</td></tr>
                                    <tr><td><i class="fas fa-map-marker-alt me-2"></i>Địa chỉ:</td><td>${driver.dia_chi || 'Chưa cập nhật'}</td></tr>
                                </table>
                                
                                <h6 class="mt-3">Bằng lái xe</h6>
                                <table class="table table-borderless table-sm">
                                    <tr><td><i class="fas fa-id-card me-2"></i>Số bằng lái:</td><td>${driver.so_bang_lai}</td></tr>
                                    <tr><td><i class="fas fa-certificate me-2"></i>Loại bằng lái:</td><td>${driver.loai_bang_lai}</td></tr>
                                    
                                    <tr><td><i class="fas fa-star me-2"></i>Điểm TB:</td><td>${rating} ★ (${reviewCount} lượt)</td></tr>
                                </table>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>Thông tin xe</h6>
                                <table class="table table-borderless table-sm">
                                    <tr><td><i class="fas fa-car me-2"></i>Loại xe:</td><td>${driver.loai_xe}</td></tr>
                                    <tr><td><i class="fas fa-hashtag me-2"></i>Biển số:</td><td><strong>${driver.bien_so_xe}</strong></td></tr>
                                    <tr><td><i class="fas fa-industry me-2"></i>Hãng xe:</td><td>${driver.hang_xe}</td></tr>
                                    <tr><td><i class="fas fa-palette me-2"></i>Màu sắc:</td><td>${driver.mau_xe}</td></tr>
                                    <tr><td><i class="fas fa-users me-2"></i>Số chỗ ngồi:</td><td>${driver.so_cho_ngoi} chỗ</td></tr>
                                </table>
                                
                                <div class="d-flex justify-content-between align-items-center mt-3 mb-2">
                                    <h6 class="mb-0">Đánh giá gần đây</h6>
                                    <a href="/views/driver-reviews.html?id=${driver.id}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye me-1"></i>Xem toàn bộ
                                    </a>
                                </div>
                                <div class="reviews" id="driver-reviews-${driver.id}">
                                    <div class="text-center text-muted">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Đang tải...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('driver-detail-content').innerHTML = content;
            
            // Hide buttons for drivers (they can't book rides)
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const isDriver = user.loai_tai_khoan === 'tai_xe';
            
            const bookBtn = document.getElementById('book-driver-btn');
            const contactBtn = document.getElementById('contact-driver-btn');
            
            if (isDriver) {
                if (bookBtn) bookBtn.style.display = 'none';
                if (contactBtn) contactBtn.style.display = 'none';
            } else {
                if (bookBtn) bookBtn.onclick = () => bookWithDriver(driver.id);
                if (contactBtn) contactBtn.onclick = () => contactDriver(driver.id);
            }
            
            // Tải đánh giá từ database
            loadDriverReviews(driver.id);
        }

        async function loadDriverReviews(driverId) {
            try {
                const res = await fetch(`${window.API_BASE_URL}/drivers/public/${driverId}/reviews`);
                const data = await res.json();
                
                const reviewsContainer = document.getElementById(`driver-reviews-${driverId}`);
                
                if (!data.success || !data.data || data.data.length === 0) {
                    reviewsContainer.innerHTML = '<small class="text-muted">Chưa có đánh giá nào</small>';
                    return;
                }
                
                // Hiển thị tối đa 3 đánh giá gần nhất
                const recentReviews = data.data.slice(0, 3);
                const reviewsHTML = recentReviews.map(review => {
                    const stars = '⭐'.repeat(review.diem_so);
                    return `
                        <div class="review-item mb-2 p-2 bg-light rounded">
                            <div class="d-flex justify-content-between">
                                <small><strong>${review.ten_nguoi_danh_gia || 'Khách hàng'}</strong></small>
                                <small class="text-warning">${stars}</small>
                            </div>
                            <small class="text-muted">${review.binh_luan || 'Không có bình luận'}</small>
                        </div>
                    `;
                }).join('');
                
                reviewsContainer.innerHTML = reviewsHTML;
            } catch (error) {
                console.error('Load reviews error:', error);
                document.getElementById(`driver-reviews-${driverId}`).innerHTML = 
                    '<small class="text-danger">Không thể tải đánh giá</small>';
            }
        }

        function bookWithDriver(driverId) {
            // Close modal if open
            const modal = bootstrap.Modal.getInstance(document.getElementById('driverDetailModal'));
            if (modal) modal.hide();
            
            // Redirect to booking page with driver pre-selected
            window.location.href = `booking.html?driver=${driverId}`;
        }

        async function contactDriver(driverId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showWarning('Vui lòng đăng nhập để liên lạc với tài xế');
                    return;
                }

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('driverDetailModal'));
                if (modal) modal.hide();

                // Request conversation with driver
                const res = await fetch(`${window.API_BASE_URL}/chat/request`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tai_xe_id: driverId })
                });

                const result = await res.json();
                
                if (result.success && result.data && result.data.id) {
                    const conversationId = result.data.id;
                    
                    // Send automatic greeting message
                    const greetingMessage = "Xin chào! Hiện tại bạn có đang nhận chuyến không ạ?";
                    
                    try {
                        await fetch(`${window.API_BASE_URL}/chat/send/${conversationId}`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ message: greetingMessage })
                        });
                    } catch (e) {
                        console.debug('Auto message error:', e);
                    }
                    
                    // Open chat widget if it exists
                    const chatToggle = document.getElementById('chatToggle');
                    if (chatToggle && window.dcApp) {
                        // Reload conversations to show the new one
                        setTimeout(() => {
                            chatToggle.click();
                        }, 500);
                        showSuccess('Đã gửi tin nhắn đến tài xế!');
                    } else {
                        showSuccess('Đã gửi yêu cầu trò chuyện! Vui lòng kiểm tra mục chat.');
                    }
                } else {
                    showError(result.message || 'Không thể gửi yêu cầu trò chuyện');
                }
            } catch (error) {
                console.error('Contact driver error:', error);
                showError('Lỗi khi liên lạc với tài xế');
            }
        }

        // ----------------------- Driver Trips (assigned to this driver) -----------------------
        // ----------------------- Driver notification polling -----------------------
        let notificationPollInterval = null;
        async function fetchDriverNotifications() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                const res = await fetch(`${window.API_BASE_URL}/drivers/notifications`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) return;
                const result = await res.json();
                if (result.success && result.data && result.data.length > 0) {
                    // Show the first pending notification(s)
                    result.data.forEach(n => {
                        if (n.status === 'pending') {
                            showDriverNotificationToast(n);
                        }
                    });
                }
            } catch (e) {
                console.debug('Driver notification fetch error', e);
            }
        }

        // ----------------------- Available trip requests - REMOVED -----------------------

        function startNotificationPolling() {
            if (notificationPollInterval) return;
            // Poll every 10 seconds
            fetchDriverNotifications();
            notificationPollInterval = setInterval(fetchDriverNotifications, 10000);
        }

        function stopNotificationPolling() {
            if (notificationPollInterval) {
                clearInterval(notificationPollInterval);
                notificationPollInterval = null;
            }
        }

        function showDriverNotificationToast(notification) {
            // Create a simple dismissible toast in the corner
            const container = document.getElementById('alert-container');
            const div = document.createElement('div');
            div.className = 'toast show align-items-center text-bg-light border';
            div.style.minWidth = '320px';
            div.style.marginBottom = '8px';
            div.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>Thông báo chuyến mới</strong><br>
                        <small class="text-muted">${notification.message || 'Bạn có chuyến mới'}</small>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-success me-2" onclick="acceptTripFromNotification(${notification.trip_id}, ${notification.id})">Nhận</button>
                            <button class="btn btn-sm btn-secondary" onclick="dismissNotification(${notification.id})">Đóng</button>
                        </div>
                    </div>
                    <button type="button" class="btn-close me-2 m-auto" aria-label="Close" onclick="dismissNotification(${notification.id})"></button>
                </div>
            `;
            container.appendChild(div);
        }

        async function dismissNotification(notificationId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;
                await fetch(`${window.API_BASE_URL}/drivers/notifications/${notificationId}/seen`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            } catch (e) { console.debug('Dismiss notification failed', e); }
        }

        async function acceptTripFromNotification(tripId, notificationId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) return showWarning('Vui lòng đăng nhập');

                const res = await fetch(`${window.API_BASE_URL}/trips/${tripId}/accept`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                });

                const result = await res.json();
                if (result.success) {
                    showSuccess('Bạn đã nhận chuyến đi');
                    // Mark notification as accepted (best-effort)
                    await fetch(`${window.API_BASE_URL}/drivers/notifications/${notificationId}/status`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'accepted' })
                    });
                } else {
                    showError(result.message || 'Không thể nhận chuyến');
                }
            } catch (e) {
                console.error('Accept trip error', e);
                showError('Lỗi khi nhận chuyến');
            }
        }
    </script>

    <style>
        .driver-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .driver-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
        }
        
        .driver-avatar {
            transition: color 0.2s;
        }
        
        .driver-card:hover .driver-avatar i {
            color: var(--primary) !important;
        }
        
        .info-item {
            font-size: 0.9rem;
        }
        
        .status-badges .badge {
            font-size: 0.7rem;
            margin-right: 0.25rem;
        }
        
        .rating .fa-star,
        .rating .fa-star-half-alt {
            font-size: 0.9rem;
        }
        
        .review-item {
            border-left: 3px solid var(--primary);
        }
        
        .stat-item {
            font-size: 0.9rem;
        }
    </style>
    <!-- Footer -->
    <footer class="bg-dark text-light py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5 class="text-white"><i class="fas fa-car"></i> DC Car Booking</h5>
                    <p class="text-light opacity-75">Hệ thống đặt xe trực tuyến hàng đầu Việt Nam</p>
                    <div class="mt-3">
                        <img src="/uploads/bocongthuong/Logo-thong-bao-mau-do-1.png" 
                             alt="Đã đăng ký Bộ Công Thương" 
                             style="height: 150px; object-fit: contain;"
                             onerror="this.style.display='none'">
                    </div>
                </div>
                <div class="col-md-4">
                    <h6 class="text-white mb-3">Liên hệ</h6>
                    <div class="text-light opacity-75">
                        <p class="mb-2"><i class="fas fa-phone"></i> Hotline: <a href="tel:19006789" class="text-light text-decoration-none">1900 6789</a></p>
                        <p class="mb-2"><i class="fas fa-envelope"></i> Email: <a href="mailto:support@dcbooking.com" class="text-light text-decoration-none">support@dcbooking.com</a></p>
                        <p class="mb-2"><i class="fab fa-facebook"></i> Facebook: <a href="https://web.facebook.com/manhcuonq204" target="_blank" class="text-light text-decoration-none">DC Booking</a></p>
                    </div>
                </div>
                <div class="col-md-4">
                    <h6 class="text-white mb-3">Địa chỉ</h6>
                    <p class="text-light opacity-75">
                        <i class="fas fa-map-marker-alt"></i> Trụ sở:<br>
                        HUTECH - Đại học Công nghệ TP.HCM (Thu Duc Campus)<br>
                        Khu Công nghệ cao XLHN, Hiệp Phú,<br>
                         Thủ Đức, Thành phố Hồ Chí Minh, Việt Nam
                    </p>
                </div>
            </div>
            <hr class="border-secondary my-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="text-light opacity-75 mb-0">© 2024 DC Car Booking. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

</body>
</html>
