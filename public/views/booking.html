<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê·∫∑t xe - DC Booking (OSM Local)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    
    <!-- Leaflet Maps CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Maps JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- OSM Parser Library with fallback -->
    <script src="https://unpkg.com/osmtogeojson@3.0.0/osmtogeojson.js" 
            onerror="console.warn('osmtogeojson library failed to load, using fallback')"></script>
    <script>
        // Fallback for osmtogeojson if CDN fails
        window.addEventListener('load', function() {
            if (typeof osmtogeojson === 'undefined') {
                console.warn('osmtogeojson not available, creating simple fallback');
                window.osmtogeojson = function(osmDoc) {
                    // Simple fallback - extract basic node information
                    const nodes = osmDoc.querySelectorAll('node[lat][lon]');
                    const features = [];
                    
                    nodes.forEach(node => {
                        const lat = parseFloat(node.getAttribute('lat'));
                        const lon = parseFloat(node.getAttribute('lon'));
                        const nameTag = node.querySelector('tag[k="name"]');
                        
                        if (nameTag) {
                            features.push({
                                type: 'Feature',
                                geometry: {
                                    type: 'Point',
                                    coordinates: [lon, lat]
                                },
                                properties: {
                                    name: nameTag.getAttribute('v')
                                }
                            });
                        }
                    });
                    
                    return {
                        type: 'FeatureCollection',
                        features: features
                    };
                };
            }
        });
    </script>
</head>
<body>
    <!-- Page-level loading overlay shown while client checks auth/profile -->
    <div id="page-loading-overlay" style="position:fixed;inset:0;background:rgba(255,255,255,0.95);z-index:2000;display:flex;align-items:center;justify-content:center;">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status" style="width:4rem;height:4rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-3 text-muted">ƒêang ki·ªÉm tra quy·ªÅn truy c·∫≠p v√† t·∫£i trang...</div>
        </div>
    </div>
    <!-- Navigation -->
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <button class="btn btn-link text-white p-0 me-3" id="sidebar-toggle" type="button">
                <i class="fas fa-bars fa-lg"></i>
            </button>
            <a class="navbar-brand fw-bold" href="../index.html">
                <i class="fas fa-car"></i> DC Booking
            </a>
            <div class="ms-auto" id="auth-nav">
                <a class="btn btn-link text-white text-decoration-none" href="#" onclick="showAuthModal()">ƒêƒÉng nh·∫≠p</a>
            </div>
            <div class="ms-auto d-none" id="user-nav">
                <div class="dropdown">
                    <a class="btn btn-link text-white text-decoration-none dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <span id="user-name"></span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="profile.html"><i class="fas fa-user me-2"></i>H·ªì s∆° c√° nh√¢n</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>ƒêƒÉng xu·∫•t</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar Menu -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <div class="sidebar-menu" id="sidebar-menu">
        <div class="sidebar-header">
            <h5 class="mb-0"><i class="fas fa-car"></i> Menu</h5>
            <button class="btn-close btn-close-white" id="sidebar-close"></button>
        </div>
        <div class="sidebar-body">
            <!-- Status Toggle (driver) -->
            <div class="status-toggle-container mb-3" id="driver-status-section">
                <div class="status-toggle" id="status-container">
                    <div>
                        <h6 class="mb-0" id="status-title">
                            <i class="fas fa-circle me-2" id="status-icon"></i>
                            <span id="status-text">ƒêang t·∫£i...</span>
                        </h6>
                        <small class="text-muted" id="status-description">ƒêang ki·ªÉm tra tr·∫°ng th√°i</small>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="statusToggle" onchange="toggleDriverStatus()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="mt-2 text-center" id="status-info">
                    <small class="text-muted">B·∫≠t ƒë·ªÉ nh·∫≠n chuy·∫øn ƒëi m·ªõi</small>
                </div>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item d-none" id="home-nav-sidebar">
                    <a class="nav-link" href="../index.html"><i class="fas fa-home me-2"></i>Trang ch·ªß</a>
                </li>
                <li class="nav-item d-none" id="booking-nav-sidebar">
                    <a class="nav-link" href="booking.html" data-auth><i class="fas fa-calendar-check me-2"></i>ƒê·∫∑t xe</a>
                </li>
                <li class="nav-item d-none" id="trips-nav-sidebar">
                    <a class="nav-link" href="trips.html" data-auth><i class="fas fa-route me-2"></i>Chuy·∫øn ƒëi</a>
                </li>
                <li class="nav-item d-none" id="drivers-nav-sidebar">
                    <a class="nav-link" href="drivers.html"><i class="fas fa-user-tie me-2"></i>T√†i x·∫ø</a>
                </li>
                <li class="nav-item d-none" id="stats-menu-item-sidebar">
                    <a class="nav-link" href="driver-dashboard.html"><i class="fas fa-chart-bar me-2"></i>Th·ªëng k√™</a>
                </li>
                <li class="nav-item d-none" id="promotions-nav-sidebar">
                    <a class="nav-link" href="promotions.html"><i class="fas fa-gift me-2"></i>Khuy·∫øn m√£i</a>
                </li>
                <li class="nav-item d-none" id="driverreg-nav-sidebar">
                    <a class="nav-link" href="../driver-registration.html"><i class="fas fa-user-plus me-2"></i>ƒêƒÉng k√Ω t√†i x·∫ø</a>
                </li>
            </ul>
        </div>
    </div>



    <!-- Main Content -->
    <div class="container my-5">
        <div class="row">
            <!-- Booking Form -->
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="fas fa-car me-2"></i>ƒê·∫∑t xe ngay</h4>
                    </div>
                    <div class="card-body">
                        <form id="booking-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="pickup-location" class="form-label">
                                        <i class="fas fa-map-marker-alt text-success me-2"></i>ƒêi·ªÉm ƒë√≥n
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="pickup-location" 
                                               placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒë√≥n ho·∫∑c ch·ªçn tr√™n b·∫£n ƒë·ªì" required>
                                        <button class="btn btn-outline-success" type="button" id="get-current-location" title="L·∫•y v·ªã tr√≠ hi·ªán t·∫°i" onclick="getCurrentLocation()">
                                            <i class="fas fa-location-arrow"></i>
                                        </button>
                                        <button class="btn btn-outline-primary" type="button" id="pickup-map-btn" title="Ch·ªçn tr√™n b·∫£n ƒë·ªì" onclick="(function(){ try{ setMapMode('pickup'); new bootstrap.Modal(document.getElementById('mapModal')).show(); }catch(e){ console.error('Inline pickup onclick error', e); } })()">
                                            <i class="fas fa-map"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">Nh·∫•n <i class="fas fa-location-arrow"></i> ƒë·ªÉ l·∫•y v·ªã tr√≠ hi·ªán t·∫°i ho·∫∑c <i class="fas fa-map"></i> ƒë·ªÉ ch·ªçn tr√™n b·∫£n ƒë·ªì</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="destination" class="form-label">
                                        <i class="fas fa-map-marker-alt text-danger me-2"></i>ƒêi·ªÉm ƒë·∫øn
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="destination" 
                                               placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒë·∫øn ho·∫∑c ch·ªçn tr√™n b·∫£n ƒë·ªì" required>
                                        <button class="btn btn-outline-primary" type="button" id="destination-map-btn" title="Ch·ªçn tr√™n b·∫£n ƒë·ªì" onclick="(function(){ try{ setMapMode('destination'); new bootstrap.Modal(document.getElementById('mapModal')).show(); }catch(e){ console.error('Inline destination onclick error', e); } })()">
                                            <i class="fas fa-map"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="pickup-date" class="form-label">
                                        <i class="fas fa-calendar me-2"></i>Ng√†y ƒë√≥n
                                    </label>
                                    <input type="date" class="form-control" id="pickup-date" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="pickup-time" class="form-label">
                                        <i class="fas fa-clock me-2"></i>Gi·ªù ƒë√≥n
                                    </label>
                                    <input type="time" class="form-control" id="pickup-time" required>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="car-type" class="form-label">
                                        <i class="fas fa-car me-2"></i>Lo·∫°i xe
                                    </label>
                                    <select class="form-select" id="car-type" required>
                                        <option value="">Ch·ªçn lo·∫°i xe</option>
                                        <option value="xe-may">Xe m√°y</option>
                                        <option value="4-cho">Xe 4 ch·ªó</option>
                                        <option value="7-cho">Xe 7 ch·ªó</option>
                                        <option value="16-cho">Xe 16 ch·ªó</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="passengers" class="form-label">
                                        <i class="fas fa-users me-2"></i>S·ªë h√†nh kh√°ch
                                    </label>
                                    <input type="number" class="form-control" id="passengers" 
                                           min="1" max="45" value="1" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="note" class="form-label">
                                    <i class="fas fa-sticky-note me-2"></i>Ghi ch√∫
                                </label>
                                <textarea class="form-control" id="note" rows="3" 
                                          placeholder="Ghi ch√∫ th√™m cho t√†i x·∫ø (n·∫øu c√≥)"></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-wallet me-2"></i>Ph∆∞∆°ng th·ª©c thanh to√°n
                                </label>
                                <div class="payment-methods">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="paymentMethod" 
                                               id="paymentCash" value="tien_mat" checked>
                                        <label class="form-check-label" for="paymentCash">
                                            <i class="fas fa-money-bill-wave text-success me-2"></i>
                                            <strong>Ti·ªÅn m·∫∑t</strong>
                                            <small class="d-block text-muted ms-4">Thanh to√°n tr·ª±c ti·∫øp v·ªõi t√†i x·∫ø</small>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="paymentMethod" 
                                               id="paymentTransfer" value="chuyen_khoan">
                                        <label class="form-check-label" for="paymentTransfer">
                                            <i class="fas fa-university text-primary me-2"></i>
                                            <strong>Chuy·ªÉn kho·∫£n</strong>
                                            <small class="d-block text-muted ms-4">Qu√©t m√£ QR sau khi ho√†n th√†nh chuy·∫øn ƒëi</small>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card border-info">
                                        <div class="card-body text-center">
                                            <h5 class="text-info mb-3">
                                                <i class="fas fa-calculator me-2"></i>∆Ø·ªõc t√≠nh gi√° c∆∞·ªõc
                                            </h5>
                                            <h3 id="estimated-price" class="text-primary mb-2">-- VND</h3>
                                            <div id="price-after-promo" style="display:none;">
                                                <small class="text-muted">Gi√° tr∆∞·ªõc khuy·∫øn m√£i: <span id="original-price" style="text-decoration:line-through"></span></small>
                                                <div class="text-success mt-1">Gi√° sau khi √°p voucher: <strong id="final-price"></strong></div>
                                            </div>
                                            <div class="pricing-details">
                                                <small class="text-muted d-block">
                                                    <i class="fas fa-route me-1"></i>
                                                    Kho·∫£ng c√°ch: <span id="distance-info">-- km</span>
                                                    <span id="distance-loading" class="spinner-border spinner-border-sm ms-2" style="display: none;" role="status"></span>
                                                </small>
                                                <small class="text-muted d-block" id="pricing-breakdown" style="display: none;">
                                                    <div class="mt-2 pt-2 border-top">
                                                        <div>Ph√≠ d·ªãch v·ª•: <span id="starting-fee">--</span></div>
                                                        <div>Ph√≠ qu√£ng ƒë∆∞·ªùng: <span id="distance-fee">--</span></div>
                                                        <div id="passenger-fee-row" style="display: none;">
                                                            Ph√≠ th√™m kh√°ch: <span id="passenger-fee">--</span>
                                                        </div>
                                                    </div>
                                                </small>
                                            </div>

                                            <!-- Promotion input area: keep only button to open promo modal -->
                                            <div id="promotion-section" class="mt-3">
                                                <div id="promo-manual-area">
                                                    <button class="btn btn-outline-primary" type="button" onclick="openPromotionModal()">
                                                        <i class="fas fa-ticket-alt me-1"></i> Nh·∫≠p / Ch·ªçn voucher
                                                    </button>
                                                </div>

                                                <div id="promo-available-area" style="display:none;" class="mt-2">
                                                    <div id="available-promotions-mini" class="row g-2"></div>
                                                    <div class="text-muted small mt-1">Ch·ªçn m·ªôt m√£ ·ªü tr√™n ƒë·ªÉ √°p d·ª•ng cho chuy·∫øn ƒëi.</div>
                                                </div>

                                                <div id="promotion-result" class="mt-2"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 d-flex align-items-end">
                                    <button type="button" class="btn btn-outline-secondary me-2" onclick="calculatePrice()">
                                        <i class="fas fa-calculator me-2"></i>T√≠nh gi√°
                                    </button>
                                    <button type="submit" class="btn btn-primary flex-fill">
                                        <i class="fas fa-check me-2"></i>ƒê·∫∑t xe ngay
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Available Drivers & Quick Actions -->
            <div class="col-lg-4">
                <!-- Customer's Bookings (visible when logged in as customer) -->
                <div id="customer-bookings-card" class="card shadow mb-3" style="display:none;">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-ticket-alt me-2"></i>ƒê∆°n c·ªßa t√¥i</h5>
                    </div>
                    <div class="card-body" style="max-height: 240px; overflow-y: auto;" id="customer-bookings-container">
                        <div class="text-center text-muted small">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem ƒë∆°n c·ªßa b·∫°n</div>
                    </div>
                </div>
                <!-- Quick Actions removed per user request -->

                <!-- Available Drivers -->
                <div class="card shadow">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>T√†i x·∫ø kh·∫£ d·ª•ng</h5>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="available-drivers">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">ƒêang t·∫£i danh s√°ch t√†i x·∫ø...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Modal -->
    <div class="modal fade" id="mapModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Ch·ªçn <span id="map-mode-text">ƒëi·ªÉm ƒë√≥n</span> tr√™n b·∫£n ƒë·ªì ƒë·ªãa ph∆∞∆°ng
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Map Info -->
                    <div class="mb-3">
                        <div class="alert alert-success">
                            <i class="fas fa-map me-2"></i>
                            <strong id="map-status-text">B·∫£n ƒë·ªì OpenStreetMap s·∫µn s√†ng</strong>
                        </div>
                    </div>
                    
                    <!-- Search Box -->
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control" id="location-search-input" 
                                   placeholder="T√¨m ki·∫øm ƒë·ªãa ƒëi·ªÉm (VD: B·∫øn Th√†nh, Ph·∫°m Ng≈© L√£o...)">
                            <button class="btn btn-primary" type="button" id="search-location-btn">
                                <i class="fas fa-search"></i> T√¨m
                            </button>
                        </div>
                        <div id="search-results" class="list-group mt-2" style="display: none; max-height: 200px; overflow-y: auto;"></div>
                    </div>
                    
                    <div class="mb-3">
                        <button class="btn btn-success btn-sm" id="current-location-map-btn">
                            <i class="fas fa-location-arrow me-2"></i>V·ªã tr√≠ hi·ªán t·∫°i
                        </button>
                        <span class="text-muted ms-2">Nh·∫•n v√†o b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn ƒë·ªãa ƒëi·ªÉm</span>
                    </div>
                    
                    <!-- Map Container -->
                    <div id="map" style="height: 400px; width: 100%; border-radius: 8px;"></div>
                    
                    <!-- Selected Location Info -->
                    <div id="selected-location-info" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-map-pin me-2"></i>ƒê·ªãa ƒëi·ªÉm ƒë√£ ch·ªçn:</h6>
                            <p id="selected-address" class="mb-0"></p>
                            <small class="text-muted">T·ªça ƒë·ªô: <span id="selected-coords"></span></small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" id="confirm-location-btn" disabled>
                        <i class="fas fa-check me-2"></i>X√°c nh·∫≠n ƒë·ªãa ƒëi·ªÉm
                    </button>
                </div>
            </div>
        </div>
    </div>
    
                <!-- Promotion Modal -->
                <div class="modal fade" id="promotionModal" tabindex="-1">
                    <div class="modal-dialog modal-md">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-ticket-alt me-2"></i>√Åp d·ª•ng voucher</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p class="small text-muted">Nh·∫≠p m√£ voucher ho·∫∑c ch·ªçn m·ªôt trong c√°c m√£ c√≤n hi·ªáu l·ª±c b√™n d∆∞·ªõi.</p>

                                <div class="mb-3">
                                    <div class="input-group">
                                        <input type="text" id="promotion-code-modal" class="form-control" placeholder="Nh·∫≠p m√£ voucher">
                                        <button class="btn btn-primary" type="button" id="apply-promo-modal-btn" onclick="applyPromotionFromModal()">√Åp d·ª•ng</button>
                                    </div>
                                </div>

                                <div id="available-promotions-modal" class="row g-2">
                                    <!-- Promotions rendered here by promotionService -->
                                    <div class="col-12 text-center text-muted small">ƒêang t·∫£i m√£ khuy·∫øn m√£i...</div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                            </div>
                        </div>
                    </div>
                </div>

    <!-- Alert Container -->
    <div id="alert-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/notifications.js"></script>
    <script src="/js/app.js"></script>
    <script>
        // ·∫®n driver status n·∫øu kh√¥ng ph·∫£i t√†i x·∫ø
        document.addEventListener('DOMContentLoaded', function() {
            try {
                let role = localStorage.getItem('role');
                if (!role && localStorage.getItem('user')) {
                    const user = JSON.parse(localStorage.getItem('user'));
                    role = user && user.role ? user.role : null;
                }
                if (role !== 'tai_xe') {
                    const statusSection = document.getElementById('driver-status-section');
                    if (statusSection) statusSection.style.display = 'none';
                }
            } catch (e) { /* ignore */ }
        });
        async function loadDriverStatus() {
            try { const token = localStorage.getItem('token'); if(!token) return; const res = await fetch(`${window.API_BASE_URL}/drivers/my-status`, { headers: { 'Authorization': `Bearer ${token}` } }); const data = await res.json(); if (data && data.success && data.data) updateStatusUI(data.data.trang_thai_tai_xe); } catch (e) { console.debug(e); }
        }
        function updateStatusUI(status) {
            const container = document.getElementById('status-container'); const toggle = document.getElementById('statusToggle'); const icon = document.getElementById('status-icon'); const text = document.getElementById('status-text'); const description = document.getElementById('status-description'); if (!container||!toggle) return; if (status==='san_sang') { container.classList.add('active'); container.classList.remove('inactive'); toggle.checked=true; icon.className='fas fa-circle me-2'; text.textContent='ƒêang ho·∫°t ƒë·ªông'; description.textContent='B·∫°n c√≥ th·ªÉ nh·∫≠n chuy·∫øn ƒëi m·ªõi'; } else { container.classList.remove('active'); container.classList.add('inactive'); toggle.checked=false; icon.className='fas fa-moon me-2'; text.textContent='Kh√¥ng ho·∫°t ƒë·ªông'; description.textContent='B·∫≠t ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫≠n chuy·∫øn'; }
        }
        async function toggleDriverStatus() { const toggle=document.getElementById('statusToggle'); if(!toggle) return; const newStatus = toggle.checked ? 'san_sang' : 'nghi_lam'; try { const token = localStorage.getItem('token'); const res = await fetch(`${window.API_BASE_URL}/drivers/status`, { method:'POST', headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${token}` }, body: JSON.stringify({ trang_thai: newStatus }) }); const data = await res.json(); if (data && data.success) { updateStatusUI(newStatus); showNotification(toggle.checked ? 'ƒê√£ b·∫≠t tr·∫°ng th√°i ho·∫°t ƒë·ªông' : 'ƒê√£ t·∫Øt tr·∫°ng th√°i ho·∫°t ƒë·ªông','success'); } else { toggle.checked = !toggle.checked; showNotification('Kh√¥ng th·ªÉ thay ƒë·ªïi tr·∫°ng th√°i','error'); } } catch (e) { console.error(e); toggle.checked = !toggle.checked; showNotification('L·ªói khi thay ƒë·ªïi tr·∫°ng th√°i','error'); } }
        document.addEventListener('DOMContentLoaded', () => setTimeout(loadDriverStatus, 600));
    </script>
    <script src="../js/promotions.js"></script>
    <script>
        // Global variables for Leaflet Maps with Local OSM
        let map;
        let marker;
        let currentMapMode = 'pickup'; // 'pickup' or 'destination'
        let selectedLocation = null;
        let osmData = null; // Store local OSM data
        let osmLayer = null; // OSM features layer

        // Debounce function to limit frequent calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Status update function like test page
        function updateMapStatus(message, type = 'info') {
            const statusElement = document.getElementById('map-status-text');
            
            if (statusElement) {
                statusElement.textContent = message;
                const alertDiv = statusElement.closest('.alert');
                if (alertDiv) {
                    alertDiv.className = 'alert mb-3 alert-' + 
                        (type === 'error' ? 'danger' : type === 'success' ? 'success' : 
                         type === 'warning' ? 'warning' : 'info');
                }
            }
            
            console.log(`[MAP] ${message}`);
        }

        // Define all functions first before using them
        function setMapMode(mode) {
            console.log('Setting map mode to:', mode);
            currentMapMode = mode;
            document.getElementById('map-mode-text').textContent = 
                mode === 'pickup' ? 'ƒëi·ªÉm ƒë√≥n' : 'ƒëi·ªÉm ƒë·∫øn';
            
            // Reset map state
            selectedLocation = null;
            if (marker) {
                marker.setOpacity(0);
            }
            document.getElementById('selected-location-info').style.display = 'none';
            document.getElementById('confirm-location-btn').disabled = true;
            const searchInputEl = document.getElementById('location-search-input');
            if (searchInputEl) searchInputEl.value = '';
            
            console.log('Map mode set to:', currentMapMode);
        }

        // Initialize Leaflet Map
        function initMap() {
            updateMapStatus('ƒêang kh·ªüi t·∫°o b·∫£n ƒë·ªì...');
            console.log('=== INITIALIZING MAP ===');
            console.log('Leaflet available:', typeof L !== 'undefined');
            
            // Show notification about local map feature
            showInfo('Trang n√†y s·ª≠ d·ª•ng d·ªØ li·ªáu OpenStreetMap, c√≥ th·ªÉ ho·∫°t ƒë·ªông offline v·ªõi v√πng ƒë√£ ch·ªçn', 4000);
            
            try {
                // Clear any existing map content
                const mapContainer = document.getElementById('map');
                if (!mapContainer) {
                    throw new Error('Map container not found');
                }
                
                mapContainer.innerHTML = ''; // Clear previous content
                
                // Check if Leaflet is loaded
                if (typeof L === 'undefined') {
                    throw new Error('Leaflet library not loaded');
                }
                
                updateMapStatus('Leaflet library s·∫µn s·∫µng');
                
                // Default location (center of OSM bounds)
                const defaultLocation = [10.789, 106.733]; // Center of loaded area
                
                // Destroy existing map if any
                if (map && map.remove) {
                    map.remove();
                }
                
                console.log('Creating Leaflet map...');
                updateMapStatus('ƒêang t·∫°o Leaflet map...');
                map = L.map('map', {
                    center: defaultLocation,
                    zoom: 13,
                    zoomControl: true,
                    attributionControl: true
                });

                // Add OpenStreetMap tiles as base layer
                updateMapStatus('ƒêang th√™m tile layer...');
                const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 18,
                    tileSize: 256,
                    zoomOffset: 0,
                    crossOrigin: true
                });
                
                tileLayer.on('tileerror', function(error) {
                    console.error('Tile loading error:', error);
                    updateMapStatus('‚ö†Ô∏è L·ªói t·∫£i tile t·ª´ OpenStreetMap', 'warning');
                });
                
                tileLayer.on('tileload', function() {
                    console.log('‚úÖ Tile loaded successfully');
                });
                
                tileLayer.addTo(map);
                console.log('Tile layer added to map');

                // Create marker
                updateMapStatus('ƒêang t·∫°o marker...');
                marker = L.marker(defaultLocation, { 
                    draggable: true,
                    opacity: 0 // Hide initially
                }).addTo(map);

                // Add click listener to map
                map.on('click', function(e) {
                    console.log('Map clicked at:', e.latlng);
                    updateMapStatus(`Clicked: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`, 'success');
                    placeMarker(e.latlng);
                });

                // Add drag listener to marker
                marker.on('dragend', function(e) {
                    console.log('Marker dragged to:', e.target.getLatLng());
                    updateLocationInfo(e.target.getLatLng());
                });
                
                console.log('Leaflet Map loaded successfully');
                updateMapStatus('B·∫£n ƒë·ªì ƒë√£ s·∫µn s√†ng! Click ƒë·ªÉ ch·ªçn v·ªã tr√≠', 'success');
                
                // Fit map to Ho Chi Minh City bounds by default
                try {
                    const hcmBounds = [[10.495, 106.465], [10.994, 106.85]]; // SW, NE
                    map.fitBounds(hcmBounds);
                } catch (e) {
                    console.warn('Could not fit bounds to HCMC:', e.message);
                }

                // Skip loading large OSM file - use online tiles instead
                console.log('Using OpenStreetMap online tiles');
                updateMapStatus('üó∫Ô∏è B·∫£n ƒë·ªì s·∫µn s√†ng! Click ƒë·ªÉ ch·ªçn ƒë·ªãa ƒëi·ªÉm', 'success');
                
            } catch (error) {
                console.error('Map initialization error:', error);
                updateMapStatus(`L·ªói: ${error.message}`, 'error');
                const mapContainer = document.getElementById('map');
                if (mapContainer) {
                    mapContainer.innerHTML = `
                        <div class="alert alert-danger text-center" style="margin: 20px;">
                            <i class="fas fa-times-circle fa-2x mb-2"></i>
                            <h5>L·ªói kh·ªüi t·∫°o b·∫£n ƒë·ªì</h5>
                            <p>Chi ti·∫øt: ${error.message}</p>
                            <button class="btn btn-primary" onclick="retryInitMap()">
                                <i class="fas fa-refresh"></i> Th·ª≠ l·∫°i
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Retry function
        function retryInitMap() {
            console.log('Retrying map initialization...');
            showNotification('info', 'ƒêang th·ª≠ l·∫°i kh·ªüi t·∫°o b·∫£n ƒë·ªì...');
            setTimeout(() => {
                initMap();
            }, 500);
        }

        async function loadLocalOSM() {
            try {
                updateMapStatus('üìÇ ƒêang t·∫£i file OSM local...');
                showNotification('info', 'ƒêang t·∫£i d·ªØ li·ªáu b·∫£n ƒë·ªì ƒë·ªãa ph∆∞∆°ng...');
                
                const response = await fetch('../assets/map.osm');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const osmXML = await response.text();
                console.log('OSM file loaded, size:', osmXML.length, 'chars');
                
                // Parse OSM XML to GeoJSON
                const parser = new DOMParser();
                const osmDoc = parser.parseFromString(osmXML, 'text/xml');
                
                // Check for XML parsing errors
                const parseError = osmDoc.querySelector('parsererror');
                if (parseError) {
                    throw new Error('XML parsing error: ' + parseError.textContent);
                }
                
                // Get bounds from OSM file
                const bounds = osmDoc.querySelector('bounds');
                if (bounds) {
                    const minlat = parseFloat(bounds.getAttribute('minlat'));
                    const minlon = parseFloat(bounds.getAttribute('minlon'));
                    const maxlat = parseFloat(bounds.getAttribute('maxlat'));
                    const maxlon = parseFloat(bounds.getAttribute('maxlon'));
                    
                    console.log('OSM bounds:', { minlat, minlon, maxlat, maxlon });
                    
                    document.getElementById('map-bounds-info').textContent = 
                        `${minlat.toFixed(4)}, ${minlon.toFixed(4)} ƒë·∫øn ${maxlat.toFixed(4)}, ${maxlon.toFixed(4)}`;
                    
                    // Fit map to bounds
                    map.fitBounds([[minlat, minlon], [maxlat, maxlon]]);
                } else {
                    console.warn('No bounds found in OSM file');
                    document.getElementById('map-bounds-info').textContent = 'Kh√¥ng t√¨m th·∫•y bounds';
                }
                
                // Check if osmtogeojson is available
                if (typeof osmtogeojson === 'undefined') {
                    throw new Error('osmtogeojson library not loaded');
                }
                
                // Convert OSM to GeoJSON
                console.log('Converting OSM to GeoJSON...');
                osmData = osmtogeojson(osmDoc);
                console.log('GeoJSON features:', osmData.features.length);
                
                // Add OSM data as layer
                if (osmLayer) {
                    map.removeLayer(osmLayer);
                }
                
                if (osmData.features.length > 0) {
                    osmLayer = L.geoJSON(osmData, {
                        style: function(feature) {
                            // Different styles for different feature types
                            const style = {
                                color: '#3388ff',
                                weight: 1,
                                opacity: 0.6,
                                fillOpacity: 0.2
                            };
                            
                            if (feature.properties.highway) {
                                style.color = '#ff7800';
                                style.weight = 2;
                            } else if (feature.properties.building) {
                                style.color = '#8b4513';
                                style.fillOpacity = 0.5;
                            } else if (feature.properties.natural) {
                                style.color = '#228b22';
                                style.fillOpacity = 0.3;
                            }
                            
                            return style;
                        },
                        onEachFeature: function(feature, layer) {
                            let popupContent = '';
                            if (feature.properties.name) {
                                popupContent += '<strong>' + feature.properties.name + '</strong><br>';
                            }
                            if (feature.properties.highway) {
                                popupContent += 'ƒê∆∞·ªùng: ' + feature.properties.highway + '<br>';
                            }
                            if (feature.properties.building) {
                                popupContent += 'T√≤a nh√†: ' + feature.properties.building + '<br>';
                            }
                            if (feature.properties.amenity) {
                                popupContent += 'Ti·ªán √≠ch: ' + feature.properties.amenity + '<br>';
                            }
                            
                            if (popupContent) {
                                layer.bindPopup(popupContent);
                            }
                        }
                    }).addTo(map);
                    
                    showNotification('success', `ƒê√£ t·∫£i th√†nh c√¥ng ${osmData.features.length} features t·ª´ b·∫£n ƒë·ªì ƒë·ªãa ph∆∞∆°ng!`);
                } else {
                    showNotification('warning', 'File OSM kh√¥ng ch·ª©a features hi·ªÉn th·ªã ƒë∆∞·ª£c');
                }
                
            } catch (error) {
                console.error('Error loading local OSM:', error);
                showNotification('error', 'L·ªói khi t·∫£i d·ªØ li·ªáu b·∫£n ƒë·ªì: ' + error.message);
                document.getElementById('map-bounds-info').textContent = 'L·ªói: ' + error.message;
                
                // Fallback: show basic info without OSM features
                showNotification('info', 'S·ª≠ d·ª•ng b·∫£n ƒë·ªì c∆° b·∫£n thay th·∫ø');
            }
        }

        // Search location using Nominatim API
        async function searchLocation() {
            const query = document.getElementById('location-search-input').value.trim();
            if (!query) {
                showNotification('warning', 'Vui l√≤ng nh·∫≠p ƒë·ªãa ƒëi·ªÉm c·∫ßn t√¨m');
                return;
            }

            try {
                updateMapStatus('üîç ƒêang t√¨m ki·∫øm...');
                const searchResults = document.getElementById('search-results');
                searchResults.innerHTML = '<div class="p-2 text-center"><i class="fas fa-spinner fa-spin"></i> ƒêang t√¨m...</div>';
                searchResults.style.display = 'block';

                // Search with Nominatim - bias to Vietnam
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?` +
                    `format=json&q=${encodeURIComponent(query)}&` +
                    `countrycodes=vn&` +
                    `viewbox=106.3,10.3,107.0,11.2&bounded=1&` +
                    `limit=5&addressdetails=1`
                );

                if (!response.ok) {
                    throw new Error('Search failed');
                }

                const results = await response.json();
                
                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="p-2 text-muted">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>';
                    updateMapStatus('‚ùå Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm', 'error');
                    return;
                }

                // Display results
                searchResults.innerHTML = '';
                results.forEach(result => {
                    const item = document.createElement('button');
                    item.type = 'button';
                    item.className = 'list-group-item list-group-item-action text-start';
                    item.innerHTML = `
                        <div class="fw-bold">${result.display_name.split(',')[0]}</div>
                        <small class="text-muted">${result.display_name}</small>
                    `;
                    item.addEventListener('click', () => {
                        const lat = parseFloat(result.lat);
                        const lng = parseFloat(result.lon);
                        map.setView([lat, lng], 16);
                        
                        // Set marker position
                        marker.setLatLng([lat, lng]);
                        marker.setOpacity(1);
                        
                        // Set selected location with address from search result
                        selectedLocation = {
                            address: result.display_name,
                            lat: lat,
                            lng: lng
                        };
                        
                        // Update UI
                        document.getElementById('selected-address').textContent = selectedLocation.address;
                        document.getElementById('selected-coords').textContent = 
                            `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
                        document.getElementById('selected-location-info').style.display = 'block';
                        document.getElementById('confirm-location-btn').disabled = false;
                        
                        searchResults.style.display = 'none';
                        document.getElementById('location-search-input').value = '';
                        updateMapStatus('‚úÖ ƒê√£ ch·ªçn ƒë·ªãa ƒëi·ªÉm', 'success');
                    });
                    searchResults.appendChild(item);
                });

                updateMapStatus(`‚úÖ T√¨m th·∫•y ${results.length} k·∫øt qu·∫£`, 'success');

            } catch (error) {
                console.error('Search error:', error);
                document.getElementById('search-results').innerHTML = 
                    '<div class="p-2 text-danger">L·ªói t√¨m ki·∫øm. Vui l√≤ng th·ª≠ l·∫°i.</div>';
                updateMapStatus('‚ùå L·ªói t√¨m ki·∫øm', 'error');
            }
        }

        function searchInLocalOSM() {
            const searchTerm = document.getElementById('map-search').value.toLowerCase();
            if (!searchTerm || !osmData) return;

            let found = false;
            
            // Search in loaded OSM features
            osmData.features.forEach(feature => {
                if (feature.properties && feature.properties.name) {
                    const name = feature.properties.name.toLowerCase();
                    if (name.includes(searchTerm)) {
                        if (feature.geometry.type === 'Point') {
                            const coords = feature.geometry.coordinates;
                            const lat = coords[1];
                            const lng = coords[0];
                            map.setView([lat, lng], 18);
                            placeMarker(L.latLng(lat, lng));
                            found = true;
                            return;
                        }
                    }
                }
            });

            if (!found) {
                showNotification('warning', 'Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm trong v√πng b·∫£n ƒë·ªì ƒë√£ t·∫£i');
            }
        }

        function placeMarker(latlng) {
            marker.setLatLng(latlng);
            marker.setOpacity(1);
            map.panTo(latlng);
            updateLocationInfo(latlng);
        }

        function updateLocationInfo(latlng) {
            // Try to find name from local OSM data first
            let addressFromOSM = null;
            
            if (osmData) {
                // Find nearest named feature
                let minDistance = Infinity;
                osmData.features.forEach(feature => {
                    if (feature.properties && feature.properties.name && feature.geometry.type === 'Point') {
                        const coords = feature.geometry.coordinates;
                        const distance = Math.sqrt(
                            Math.pow(coords[1] - latlng.lat, 2) + 
                            Math.pow(coords[0] - latlng.lng, 2)
                        );
                        if (distance < minDistance && distance < 0.001) { // Within ~100m
                            minDistance = distance;
                            addressFromOSM = feature.properties.name;
                        }
                    }
                });
            }
            
            if (addressFromOSM) {
                selectedLocation = {
                    address: addressFromOSM,
                    lat: latlng.lat,
                    lng: latlng.lng
                };
                
                document.getElementById('selected-address').textContent = selectedLocation.address;
                document.getElementById('selected-coords').textContent = 
                    `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
                
                document.getElementById('selected-location-info').style.display = 'block';
                document.getElementById('confirm-location-btn').disabled = false;
            } else {
                // Fallback to online geocoding
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}&addressdetails=1`)
                    .then(response => response.json())
                    .then(data => {
                        selectedLocation = {
                            address: data.display_name || `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`,
                            lat: latlng.lat,
                            lng: latlng.lng
                        };

                        document.getElementById('selected-address').textContent = selectedLocation.address;
                        document.getElementById('selected-coords').textContent = 
                            `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
                        
                        document.getElementById('selected-location-info').style.display = 'block';
                        const confirmBtn = document.getElementById('confirm-location-btn');
                        if (confirmBtn) confirmBtn.disabled = false;
                    })
                    .catch(error => {
                        console.error('Geocoding error:', error);
                        selectedLocation = {
                            address: `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`,
                            lat: latlng.lat,
                            lng: latlng.lng
                        };

                        document.getElementById('selected-address').textContent = selectedLocation.address;
                        document.getElementById('selected-coords').textContent = 
                            `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
                        
                        document.getElementById('selected-location-info').style.display = 'block';
                        const confirmBtn2 = document.getElementById('confirm-location-btn');
                        if (confirmBtn2) confirmBtn2.disabled = false;
                    });
            }
        }

        function confirmLocation() {
            console.log('üéØ Confirming location for mode:', currentMapMode);
            console.log('üìç Selected location:', selectedLocation);
            
            if (selectedLocation) {
                const targetInput = currentMapMode === 'pickup' ? 
                    document.getElementById('pickup-location') : 
                    document.getElementById('destination');
                
                console.log('üéØ Target input element:', targetInput.id);
                console.log('üìù Setting address:', selectedLocation.address);
                
                targetInput.value = selectedLocation.address;
                targetInput.setAttribute('data-lat', selectedLocation.lat);
                targetInput.setAttribute('data-lng', selectedLocation.lng);
                
                // Close modal (use getOrCreateInstance to ensure instance exists)
                try {
                    const modalEl = document.getElementById('mapModal');
                    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                    modal.hide();

                    // Extra cleanup: remove any leftover backdrop and body class if bootstrap failed to remove
                    setTimeout(() => {
                        try {
                            document.body.classList.remove('modal-open');
                            const backdrops = document.querySelectorAll('.modal-backdrop');
                            backdrops.forEach(b => b.parentElement && b.parentElement.removeChild(b));
                        } catch (e) {
                            console.debug('Backdrop cleanup error', e);
                        }
                    }, 50);
                } catch (e) {
                    console.warn('Could not hide map modal cleanly:', e);
                }
                
                showNotification('success', `ƒê√£ ch·ªçn ${currentMapMode === 'pickup' ? 'ƒëi·ªÉm ƒë√≥n' : 'ƒëi·ªÉm ƒë·∫øn'}: ${selectedLocation.address}`);
                
                // Auto calculate price if both locations are set
                if (document.getElementById('pickup-location').value && document.getElementById('destination').value) {
                    calculatePrice(); // Now async
                }
            } else {
                console.log('‚ùå No selected location');
                showNotification('warning', 'Vui l√≤ng ch·ªçn m·ªôt ƒë·ªãa ƒëi·ªÉm tr√™n b·∫£n ƒë·ªì');
            }
        }

        function getCurrentLocationOnMap() {
            if (navigator.geolocation) {
                updateMapStatus('üìç ƒêang l·∫•y v·ªã tr√≠ hi·ªán t·∫°i...');
                navigator.geolocation.getCurrentPosition(
                    async function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const userLocation = [lat, lng];
                        
                        // Set marker
                        marker.setLatLng(userLocation);
                        marker.setOpacity(1);
                        map.setView(userLocation, 18);
                        
                        // Get address from Nominatim with better error handling
                        try {
                            updateMapStatus('üîç ƒêang t√¨m ƒë·ªãa ch·ªâ...');
                            console.log('Fetching address for:', lat, lng);
                            
                            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1&accept-language=vi`;
                            console.log('Nominatim URL:', url);
                            
                            const response = await fetch(url, {
                                headers: {
                                    'Accept': 'application/json'
                                }
                            });
                            
                            console.log('Response status:', response.status);
                            
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            
                            const data = await response.json();
                            console.log('Nominatim response:', data);
                            
                            if (data.error) {
                                throw new Error(data.error);
                            }
                            
                            // Build Vietnamese address from components
                            let address = '';
                            if (data.address) {
                                const parts = [];
                                if (data.address.road) parts.push(data.address.road);
                                else if (data.address.street) parts.push(data.address.street);
                                
                                if (data.address.suburb) parts.push(data.address.suburb);
                                else if (data.address.quarter) parts.push(data.address.quarter);
                                
                                if (data.address.city_district) parts.push(data.address.city_district);
                                else if (data.address.district) parts.push(data.address.district);
                                
                                if (data.address.city) parts.push(data.address.city);
                                
                                address = parts.length > 0 ? parts.join(', ') : data.display_name;
                            } else {
                                address = data.display_name;
                            }
                            
                            if (!address) {
                                throw new Error('Kh√¥ng c√≥ ƒë·ªãa ch·ªâ trong k·∫øt qu·∫£');
                            }
                            
                            selectedLocation = {
                                address: address,
                                lat: lat,
                                lng: lng
                            };
                            
                            console.log('Selected location:', selectedLocation);
                            
                            document.getElementById('selected-address').textContent = selectedLocation.address;
                            document.getElementById('selected-coords').textContent = 
                                `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
                            document.getElementById('selected-location-info').style.display = 'block';
                            document.getElementById('confirm-location-btn').disabled = false;
                            
                            updateMapStatus('‚úÖ ƒê√£ l·∫•y v·ªã tr√≠ hi·ªán t·∫°i', 'success');
                            showNotification('success', 'ƒê√£ l·∫•y v·ªã tr√≠ hi·ªán t·∫°i c·ªßa b·∫°n');
                            
                        } catch (error) {
                            console.error('Geocoding error:', error);
                            console.error('Error details:', error.message);
                            
                            selectedLocation = {
                                address: `${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                                lat: lat,
                                lng: lng
                            };
                            
                            document.getElementById('selected-address').textContent = selectedLocation.address;
                            document.getElementById('selected-coords').textContent = 
                                `T·ªça ƒë·ªô: ${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
                            document.getElementById('selected-location-info').style.display = 'block';
                            document.getElementById('confirm-location-btn').disabled = false;
                            
                            updateMapStatus('‚ö†Ô∏è ƒê√£ l·∫•y v·ªã tr√≠ (kh√¥ng c√≥ ƒë·ªãa ch·ªâ)', 'warning');
                            showNotification('warning', `Kh√¥ng th·ªÉ l·∫•y ƒë·ªãa ch·ªâ: ${error.message}`);
                        }
                    },
                    function(error) {
                        console.error('Geolocation error:', error);
                        updateMapStatus('‚ùå Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠', 'error');
                        showNotification('error', 'Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ hi·ªán t·∫°i. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p v·ªã tr√≠.');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                showNotification('error', 'Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã');
                updateMapStatus('‚ùå Kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã', 'error');
            }
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                const button = document.getElementById('get-current-location');
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                button.disabled = true;

                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Try to get address from local OSM first
                        let addressFromOSM = null;
                        if (osmData) {
                            let minDistance = Infinity;
                            osmData.features.forEach(feature => {
                                if (feature.properties && feature.properties.name && feature.geometry.type === 'Point') {
                                    const coords = feature.geometry.coordinates;
                                    const distance = Math.sqrt(
                                        Math.pow(coords[1] - lat, 2) + 
                                        Math.pow(coords[0] - lng, 2)
                                    );
                                    if (distance < minDistance && distance < 0.001) {
                                        minDistance = distance;
                                        addressFromOSM = feature.properties.name;
                                    }
                                }
                            });
                        }
                        
                        if (addressFromOSM) {
                            document.getElementById('pickup-location').value = addressFromOSM;
                            document.getElementById('pickup-location').setAttribute('data-lat', lat);
                            document.getElementById('pickup-location').setAttribute('data-lng', lng);
                            showNotification('success', 'ƒê√£ l·∫•y v·ªã tr√≠ t·ª´ b·∫£n ƒë·ªì ƒë·ªãa ph∆∞∆°ng');
                            
                            button.innerHTML = '<i class="fas fa-location-arrow"></i>';
                            button.disabled = false;
                        } else {
                            // Fallback to online geocoding
                            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`)
                                .then(response => response.json())
                                .then(data => {
                                    const address = data.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                                    document.getElementById('pickup-location').value = address;
                                    document.getElementById('pickup-location').setAttribute('data-lat', lat);
                                    document.getElementById('pickup-location').setAttribute('data-lng', lng);
                                    showNotification('success', 'ƒê√£ l·∫•y v·ªã tr√≠ hi·ªán t·∫°i c·ªßa b·∫°n');
                                })
                                .catch(error => {
                                    console.error('Geocoding error:', error);
                                    document.getElementById('pickup-location').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                                    document.getElementById('pickup-location').setAttribute('data-lat', lat);
                                    document.getElementById('pickup-location').setAttribute('data-lng', lng);
                                    showNotification('success', 'ƒê√£ l·∫•y v·ªã tr√≠ hi·ªán t·∫°i c·ªßa b·∫°n');
                                })
                                .finally(() => {
                                    button.innerHTML = '<i class="fas fa-location-arrow"></i>';
                                    button.disabled = false;
                                });
                        }
                    },
                    function(error) {
                        let errorMsg = 'Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ hi·ªán t·∫°i';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg = 'B·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p v·ªã tr√≠';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg = 'Th√¥ng tin v·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng';
                                break;
                            case error.TIMEOUT:
                                errorMsg = 'Y√™u c·∫ßu l·∫•y v·ªã tr√≠ ƒë√£ h·∫øt th·ªùi gian';
                                break;
                        }
                        showNotification('error', errorMsg);
                        
                        button.innerHTML = '<i class="fas fa-location-arrow"></i>';
                        button.disabled = false;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                showNotification('error', 'Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã');
            }
        }

        async function calculatePrice() {
            const carType = document.getElementById('car-type').value;
            const passengers = parseInt(document.getElementById('passengers').value) || 1;
            const pickupInput = document.getElementById('pickup-location');
            const destinationInput = document.getElementById('destination');
            
            // Reset display if missing info
            if (!carType || !pickupInput.value || !destinationInput.value) {
                document.getElementById('estimated-price').textContent = '-- VND';
                document.getElementById('distance-info').textContent = '-- km';
                document.getElementById('pricing-breakdown').style.display = 'none';
                clearRoute(); // Clear any existing route
                return;
            }

            // Enhanced pricing structure
            const pricingStructure = {
                'xe-may': {
                    basePrice: 6000,    // 6k/km
                    startingFee: 7000,  // 7k
                    name: 'Xe m√°y'
                },
                '4-cho': {
                    basePrice: 10000,   // 10k/km
                    startingFee: 12000, // 12k
                    name: 'Xe 4 ch·ªó'
                },
                '7-cho': {
                    basePrice: 13000,   // 13k/km
                    startingFee: 16000, // 16k
                    name: 'Xe 7 ch·ªó'
                },
                '16-cho': {
                    basePrice: 18000,   // 18k/km
                    startingFee: 22000, // 22k
                    name: 'Xe 16 ch·ªó'
                }
            };

            const pricing = pricingStructure[carType] || pricingStructure['4-cho'];
            let distance = 0;
            let duration = 0;
            let isRealDistance = false;
            let routeSource = '∆∞·ªõc t√≠nh';

            // Calculate distance if coordinates are available
            const pickupLat = parseFloat(pickupInput.getAttribute('data-lat'));
            const pickupLng = parseFloat(pickupInput.getAttribute('data-lng'));
            const destLat = parseFloat(destinationInput.getAttribute('data-lat'));
            const destLng = parseFloat(destinationInput.getAttribute('data-lng'));

            if (pickupLat && pickupLng && destLat && destLng) {
                // Show loading state
                document.getElementById('distance-info').textContent = 'ƒêang t√≠nh theo ƒë∆∞·ªùng ƒëi...';
                document.getElementById('distance-loading').style.display = 'inline-block';
                
                try {
                    // Try to get real road distance
                    const routeData = await calculateRoadDistance(pickupLat, pickupLng, destLat, destLng);
                    distance = routeData.distance;
                    duration = routeData.duration;
                    routeSource = routeData.source;
                    isRealDistance = true;
                    
                    console.log('üõ£Ô∏è Route calculated:', {
                        distance: distance.toFixed(2) + 'km',
                        duration: Math.round(duration) + ' ph√∫t',
                        source: routeSource
                    });
                } catch (error) {
                    console.error('Route calculation failed:', error);
                    // Fallback to enhanced straight line
                    distance = applyCityCorrectionFactor(
                        calculateDistance(pickupLat, pickupLng, destLat, destLng),
                        pickupLat, pickupLng, destLat, destLng
                    );
                    duration = estimateTime(distance);
                    routeSource = 'Enhanced Haversine';
                }
            } else {
                // Estimate based on text if no coordinates
                distance = estimateDistanceFromText(pickupInput.value, destinationInput.value);
                duration = estimateTime(distance);
                routeSource = 'Text estimation';
            }

            // Calculate pricing components
            const distancePrice = distance * pricing.basePrice;
            const startingFee = pricing.startingFee;
            
            // Add passenger surcharge for larger groups
            let passengerSurcharge = 0;
            if (passengers > 4 && carType === '4-cho') {
                passengerSurcharge = (passengers - 4) * 5000; // 5k per extra passenger
            }
            
            const totalPrice = startingFee + distancePrice + passengerSurcharge;

            // Expose last calculated total (pre-discount) so promotionService can use the live order total
            try { window.lastCalculatedTotal = Math.round(totalPrice); } catch (e) { console.debug('Cannot set lastCalculatedTotal', e); }

            // Apply promotion if any
            let discount = 0;
            try {
                if (typeof promotionService !== 'undefined' && promotionService.getAppliedPromotion()) {
                    discount = parseFloat(promotionService.getAppliedPromotion().gia_tri_giam) || 0;
                }
            } catch (e) {
                console.debug('No promotion service available or no promotion applied', e);
            }

            const finalPrice = Math.max(0, Math.round(totalPrice - discount));

            // Update display with detailed breakdown (show final price; show original if discount applied)
            document.getElementById('estimated-price').textContent = new Intl.NumberFormat('vi-VN').format(finalPrice) + ' VND';

            if (discount > 0) {
                const origEl = document.getElementById('original-price');
                const finalEl = document.getElementById('final-price');
                const priceAfterPromo = document.getElementById('price-after-promo');
                if (origEl && finalEl && priceAfterPromo) {
                    origEl.textContent = new Intl.NumberFormat('vi-VN').format(Math.round(totalPrice)) + ' VND';
                    finalEl.textContent = new Intl.NumberFormat('vi-VN').format(finalPrice) + ' VND';
                    priceAfterPromo.style.display = 'block';
                }
            } else {
                const priceAfterPromo = document.getElementById('price-after-promo');
                if (priceAfterPromo) priceAfterPromo.style.display = 'none';
            }
            
            const distanceText = `${distance.toFixed(1)} km (${routeSource})`;
            const durationText = duration > 0 ? ` ‚Ä¢ ${Math.round(duration)} ph√∫t` : '';
        document.getElementById('distance-info').textContent = distanceText + durationText;
        // Expose last calculated distance and duration for booking payload
        try { window.lastCalculatedDistance = distance; window.lastCalculatedDuration = duration; } catch (e) { console.debug('Cannot set lastCalculatedDistance', e); }
        document.getElementById('distance-loading').style.display = 'none';

            // Show detailed pricing breakdown
            document.getElementById('starting-fee').textContent = 
                new Intl.NumberFormat('vi-VN').format(startingFee) + ' VND';
            document.getElementById('distance-fee').textContent = 
                new Intl.NumberFormat('vi-VN').format(Math.round(distancePrice)) + ' VND';
            
            if (passengerSurcharge > 0) {
                document.getElementById('passenger-fee').textContent = 
                    new Intl.NumberFormat('vi-VN').format(passengerSurcharge) + ' VND';
                document.getElementById('passenger-fee-row').style.display = 'block';
            } else {
                document.getElementById('passenger-fee-row').style.display = 'none';
            }
            
            document.getElementById('pricing-breakdown').style.display = 'block';

            // Show price breakdown in console for debugging
            console.log('üí∞ Price Breakdown:', {
                carType: pricing.name,
                distance: distance.toFixed(1) + 'km',
                duration: Math.round(duration) + ' ph√∫t',
                startingFee: startingFee.toLocaleString() + ' VND',
                distancePrice: distancePrice.toLocaleString() + ' VND',
                passengerSurcharge: passengerSurcharge.toLocaleString() + ' VND',
                total: totalPrice.toLocaleString() + ' VND',
                source: routeSource
            });

            // Add route visualization if both coordinates available
            if (isRealDistance && map) {
                drawRoute(pickupLat, pickupLng, destLat, destLng);
            }
        }

        // Clear route visualization
        function clearRoute() {
            if (!map) return;
            
            try {
                if (routeLine) {
                    map.removeLayer(routeLine);
                    routeLine = null;
                }
                if (pickupMarker) {
                    map.removeLayer(pickupMarker);
                    pickupMarker = null;
                }
                if (destMarker) {
                    map.removeLayer(destMarker);
                    destMarker = null;
                }
            } catch (error) {
                console.error('Error clearing route:', error);
            }
        }

        // Calculate distance between two coordinates using Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c; // Distance in kilometers
            return Math.max(1, distance); // Minimum 1km
        }

        // Calculate realistic road distance using routing API
        async function calculateRoadDistance(lat1, lon1, lat2, lon2) {
            try {
                // Try OpenRouteService first (free tier: 2000 requests/day)
                const orsUrl = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=5b3ce3597851110001cf6248YOUR_API_KEY&start=${lon1},${lat1}&end=${lon2},${lat2}`;
                
                // Since we don't have API key, use OSRM (free, no key needed)
                const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=false&alternatives=false&steps=false`;
                
                console.log('üõ£Ô∏è Fetching road distance from OSRM...');
                const response = await fetch(osrmUrl);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.routes && data.routes.length > 0) {
                        const roadDistance = data.routes[0].distance / 1000; // Convert to km
                        const duration = data.routes[0].duration / 60; // Convert to minutes
                        
                        console.log('‚úÖ OSRM Response:', {
                            roadDistance: roadDistance.toFixed(2) + 'km',
                            duration: Math.round(duration) + ' ph√∫t',
                            geometry: data.routes[0].geometry
                        });
                        
                        return {
                            distance: roadDistance,
                            duration: duration,
                            geometry: data.routes[0].geometry,
                            source: 'OSRM'
                        };
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Routing API failed:', error.message);
            }
            
            // Fallback: Enhanced Haversine with city correction factors
            const straightDistance = calculateDistance(lat1, lon1, lat2, lon2);
            const correctedDistance = applyCityCorrectionFactor(straightDistance, lat1, lon1, lat2, lon2);
            
            return {
                distance: correctedDistance,
                duration: estimateTime(correctedDistance),
                source: 'Enhanced Haversine'
            };
        }

        // Apply realistic correction factors for Ho Chi Minh City roads
        function applyCityCorrectionFactor(distance, lat1, lon1, lat2, lon2) {
            // Base correction factor for urban roads (typically 1.3-1.5x straight line)
            let correctionFactor = 1.35;
            
            // Ho Chi Minh City specific factors
            const avgLat = (lat1 + lat2) / 2;
            const avgLon = (lon1 + lon2) / 2;
            
            // City center (denser road network, more detours)
            if (avgLat >= 10.7 && avgLat <= 10.8 && avgLon >= 106.6 && avgLon <= 106.75) {
                correctionFactor = 1.45; // Qu·∫≠n 1, 3, 4, 5 area
            }
            
            // Suburban areas (more direct routes)
            else if (avgLat < 10.7 || avgLat > 10.85 || avgLon < 106.6 || avgLon > 106.8) {
                correctionFactor = 1.25; // Qu·∫≠n 7, 9, Th·ªß ƒê·ª©c area
            }
            
            // Bridge/river crossing adjustment
            if (Math.abs(lat1 - lat2) > 0.05 || Math.abs(lon1 - lon2) > 0.05) {
                correctionFactor *= 1.1; // Add 10% for long distance/river crossing
            }
            
            // Minimum and maximum bounds
            const correctedDistance = distance * correctionFactor;
            return Math.max(1, Math.min(correctedDistance, distance * 2)); // Cap at 2x straight line
        }

        // Estimate travel time based on distance and city conditions
        function estimateTime(distance) {
            // Average speed in Ho Chi Minh City considering traffic
            let avgSpeed = 25; // km/h during normal hours
            
            const currentHour = new Date().getHours();
            
            // Rush hour adjustments
            if ((currentHour >= 7 && currentHour <= 9) || (currentHour >= 17 && currentHour <= 19)) {
                avgSpeed = 15; // Rush hour
            } else if (currentHour >= 22 || currentHour <= 6) {
                avgSpeed = 35; // Night time
            }
            
            return (distance / avgSpeed) * 60; // Convert to minutes
        }

        // Estimate distance from text addresses (fallback when no coordinates)
        function estimateDistanceFromText(pickup, destination) {
            // Simple heuristic based on common patterns in Ho Chi Minh City
            const patterns = {
                // Airport routes
                's√¢n bay': { base: 15, multiplier: 1.2 },
                't√¢n s∆°n nh·∫•t': { base: 15, multiplier: 1.2 },
                
                // Districts
                'qu·∫≠n 1': { base: 8, multiplier: 1.0 },
                'qu·∫≠n 2': { base: 12, multiplier: 1.1 },
                'qu·∫≠n 3': { base: 10, multiplier: 1.0 },
                'qu·∫≠n 4': { base: 9, multiplier: 1.0 },
                'qu·∫≠n 5': { base: 11, multiplier: 1.0 },
                'qu·∫≠n 7': { base: 15, multiplier: 1.2 },
                'qu·∫≠n 9': { base: 20, multiplier: 1.3 },
                'b√¨nh d∆∞∆°ng': { base: 25, multiplier: 1.4 },
                'ƒë·ªìng nai': { base: 30, multiplier: 1.5 },
                
                // Landmarks
                'bitexco': { base: 8, multiplier: 1.0 },
                'landmark': { base: 12, multiplier: 1.1 },
                'vincom': { base: 10, multiplier: 1.0 },
                'ch·ª£ b·∫øn th√†nh': { base: 8, multiplier: 1.0 }
            };

            const text = (pickup + ' ' + destination).toLowerCase();
            let estimatedDistance = 10; // Default 10km

            for (const [pattern, config] of Object.entries(patterns)) {
                if (text.includes(pattern)) {
                    estimatedDistance = Math.max(estimatedDistance, config.base * config.multiplier);
                }
            }

            return estimatedDistance;
        }

        // Draw route line on map
        let routeLine = null;
        let pickupMarker = null;
        let destMarker = null;

        async function drawRoute(pickupLat, pickupLng, destLat, destLng) {
            if (!map) return;

            try {
                // Remove existing route and markers
                clearRoute();

                // Try to get actual route geometry from OSRM
                let routeCoords = null;
                try {
                    const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${pickupLng},${pickupLat};${destLng},${destLat}?overview=full&geometries=geojson`;
                    const response = await fetch(osrmUrl);
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.routes && data.routes.length > 0 && data.routes[0].geometry) {
                            // Convert GeoJSON coordinates to Leaflet format [lat, lng]
                            routeCoords = data.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
                            console.log('‚úÖ Got real route geometry from OSRM');
                        }
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not fetch route geometry:', error.message);
                }

                // Fallback to straight line if no route geometry
                if (!routeCoords) {
                    routeCoords = [
                        [pickupLat, pickupLng],
                        [destLat, destLng]
                    ];
                    console.log('üìè Using straight line route');
                }

                // Create route line with different styles for real vs straight routes
                const isRealRoute = routeCoords.length > 2;
                routeLine = L.polyline(routeCoords, {
                    color: isRealRoute ? '#000066' : '#28a745',
                    weight: isRealRoute ? 5 : 4,
                    opacity: 0.8,
                    dashArray: isRealRoute ? null : '10, 5'
                }).addTo(map);

                // Add markers for pickup and destination
                pickupMarker = L.marker([pickupLat, pickupLng], {
                    icon: L.divIcon({
                        className: 'custom-marker pickup-marker',
                        html: '<div style="background: #28a745; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">A</div>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(map);

                destMarker = L.marker([destLat, destLng], {
                    icon: L.divIcon({
                        className: 'custom-marker dest-marker',
                        html: '<div style="background: #dc3545; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">B</div>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(map);

                // Add popups
                pickupMarker.bindPopup('<strong>üìç ƒêi·ªÉm ƒë√≥n</strong><br>' + document.getElementById('pickup-location').value);
                destMarker.bindPopup('<strong>üéØ ƒêi·ªÉm ƒë·∫øn</strong><br>' + document.getElementById('destination').value);

                // Fit map to show the route
                const group = L.featureGroup([routeLine, pickupMarker, destMarker]);
                map.fitBounds(group.getBounds().pad(0.1));

                console.log(`üó∫Ô∏è Route drawn on map (${isRealRoute ? 'real route' : 'straight line'})`);
            } catch (error) {
                console.error('Error drawing route:', error);
            }
        }

        // Copy remaining functions from original booking.html
        document.addEventListener('DOMContentLoaded', function() {
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('pickup-date').setAttribute('min', today);
            document.getElementById('pickup-date').value = today;

            // Set default time to current time + 1 hour
            const now = new Date();
            now.setHours(now.getHours() + 1);
            const timeString = now.toTimeString().slice(0, 5);
            document.getElementById('pickup-time').value = timeString;

            // Load available drivers
            loadAvailableDrivers();
            // Load recent bookings if user is logged in as customer
            try { loadCustomerBookings(); } catch (e) { console.debug('loadCustomerBookings init failed', e); }

            // Setup form submission
            document.getElementById('booking-form').addEventListener('submit', function(e) {
                e.preventDefault();
                submitBooking();
            });

            // Add event listeners for map buttons
            const pickupMapBtn = document.getElementById('pickup-map-btn');
            const destinationMapBtn = document.getElementById('destination-map-btn');
            const mapSelectBtn = document.getElementById('map-select-btn');
            
            console.log('üîó Setting up event listeners...');
            console.log('Pickup button found:', !!pickupMapBtn);
            console.log('Destination button found:', !!destinationMapBtn);
            console.log('Map select button found:', !!mapSelectBtn);
            
            if (pickupMapBtn) {
                pickupMapBtn.addEventListener('click', function() {
                    console.log('üöó Pickup map button clicked');
                    setMapMode('pickup');
                    const modal = new bootstrap.Modal(document.getElementById('mapModal'));
                    modal.show();
                });
            } else {
                console.error('‚ùå Pickup map button not found!');
            }

            // Small "get current location" button next to pickup input
            const getCurrentLocationBtn = document.getElementById('get-current-location');
            if (getCurrentLocationBtn) {
                getCurrentLocationBtn.addEventListener('click', function() {
                    try {
                        getCurrentLocation();
                    } catch (e) {
                        console.error('Error calling getCurrentLocation():', e);
                    }
                });
            } else {
                console.warn('get-current-location button not found');
            }

            if (destinationMapBtn) {
                destinationMapBtn.addEventListener('click', function() {
                    console.log('üéØ Destination map button clicked');
                    setMapMode('destination');
                    const modal = new bootstrap.Modal(document.getElementById('mapModal'));
                    modal.show();
                });
            } else {
                console.error('‚ùå Destination map button not found!');
            }

            if (mapSelectBtn) {
                mapSelectBtn.addEventListener('click', function() {
                    console.log('üó∫Ô∏è Quick map select button clicked (pickup mode)');
                    setMapMode('pickup');
                    const modal = new bootstrap.Modal(document.getElementById('mapModal'));
                    modal.show();
                });
            } else {
                console.error('‚ùå Map select button not found!');
            }

            // Add event listeners for modal buttons
            document.getElementById('search-location-btn').addEventListener('click', searchLocation);
            document.getElementById('location-search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchLocation();
                }
            });
            document.getElementById('current-location-map-btn').addEventListener('click', getCurrentLocationOnMap);
            document.getElementById('confirm-location-btn').addEventListener('click', confirmLocation);

            // Fix the confirm-location button ID reference
            window.confirmLocationBtn = document.getElementById('confirm-location-btn');

            // Auto calculate price when inputs change
            ['pickup-location', 'destination', 'car-type', 'passengers'].forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('change', calculatePrice);
                element.addEventListener('input', debounce(calculatePrice, 1000)); // Delay for typing
            });

            // Map modal event listeners
            document.getElementById('mapModal').addEventListener('show.bs.modal', function() {
                console.log('Map modal opening...');
                console.log('Current mode when modal opens:', currentMapMode);
                // Don't reset mode here - let the button click set the mode
                    setTimeout(() => {
                        try {
                            if (map) {
                                console.log('Refreshing existing map...');
                                map.invalidateSize(); // Refresh map
                                // Reset view to HCMC bounds instead of a tight city center
                                try {
                                    const hcmBounds = [[10.495, 106.465], [10.994, 106.85]];
                                    map.fitBounds(hcmBounds);
                                } catch (e) {
                                    console.warn('Could not fit bounds on modal show:', e.message);
                                }
                            } else {
                                console.log('Initializing new map...');
                                initMap(); // Initialize map if not done
                            }
                        } catch (error) {
                            console.error('Map initialization error:', error);
                            // Fallback: show error message in map container
                            const mapContainer = document.getElementById('map');
                            if (mapContainer) {
                                mapContainer.innerHTML = `
                                <div class="alert alert-warning text-center" style="margin: 50px;">
                                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                    <h5>Kh√¥ng th·ªÉ t·∫£i b·∫£n ƒë·ªì</h5>
                                    <p>L·ªói: ${error.message}</p>
                                    <button class="btn btn-primary" onclick="retryInitMap()">Th·ª≠ l·∫°i</button>
                                </div>
                            `;
                            }
                        }
                    }, 500); // Increase timeout
            });

            // Ensure modal hide/hidden always perform cleanup to avoid lingering backdrop or modal-open state
            try {
                const mapModalEl = document.getElementById('mapModal');

                mapModalEl.addEventListener('hide.bs.modal', function () {
                    // brief cleanup attempt right before hide to minimize flicker
                    try {
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        backdrops.forEach(b => b.parentElement && b.parentElement.removeChild(b));
                        document.body.classList.remove('modal-open');
                        document.body.style.paddingRight = '';
                    } catch (e) {
                        console.debug('Pre-hide backdrop cleanup failed', e);
                    }
                });

                mapModalEl.addEventListener('hidden.bs.modal', function () {
                    // Final cleanup after modal is fully hidden
                    try {
                        // Remove any leftover backdrops
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        backdrops.forEach(b => b.parentElement && b.parentElement.removeChild(b));

                        // Restore body state
                        document.body.classList.remove('modal-open');
                        document.body.style.paddingRight = '';

                        // Re-enable confirm button to default state
                        const confirmBtn = document.getElementById('confirm-location-btn');
                        if (confirmBtn) confirmBtn.disabled = true;

                        // Focus the relevant input on page so user can continue typing
                        try {
                            const focusTarget = currentMapMode === 'pickup' ? document.getElementById('pickup-location') : document.getElementById('destination');
                            if (focusTarget) {
                                focusTarget.focus();
                            }
                        } catch (e) { console.debug('Refocus after modal hide failed', e); }

                        // Slight delay to allow Bootstrap internals to finish removing inline styles
                        setTimeout(() => {
                            try {
                                document.body.style.overflow = '';
                            } catch (e) { /* ignore */ }
                        }, 100);
                    } catch (e) {
                        console.debug('Post-hidden backdrop cleanup failed', e);
                    }
                });
            } catch (e) {
                console.debug('Could not attach modal hide handlers', e);
            }

            // Make sure all functions are available before DOM loads
            window.setMapMode = setMapMode;
            window.confirmLocation = confirmLocation;
            window.getCurrentLocationOnMap = getCurrentLocationOnMap;
            window.searchInLocalOSM = searchInLocalOSM;
            window.loadLocalOSM = loadLocalOSM;
            window.retryInitMap = retryInitMap;
            window.testMapInit = testMapInit;
            window.testDestinationButton = testDestinationButton;
            
            // Promotion mode toggle (manual vs available)
            try {
                const manualRadio = document.getElementById('promo-manual');
                const availableRadio = document.getElementById('promo-available');
                const manualArea = document.getElementById('promo-manual-area');
                const availableArea = document.getElementById('promo-available-area');

                function updatePromoMode() {
                    if (availableRadio && availableRadio.checked) {
                        if (manualArea) manualArea.style.display = 'none';
                        if (availableArea) availableArea.style.display = 'block';
                    } else {
                        if (manualArea) manualArea.style.display = 'block';
                        if (availableArea) availableArea.style.display = 'none';
                    }
                }

                if (manualRadio) manualRadio.addEventListener('change', updatePromoMode);
                if (availableRadio) availableRadio.addEventListener('change', updatePromoMode);
                // Initialize
                updatePromoMode();
            } catch (e) { console.debug('promo mode toggle init failed', e); }
        });

        // Copy existing functions from original booking.html
        async function loadAvailableDrivers() {
            try {
                const response = await fetch('/api/drivers/available');
                const result = await response.json();
                
                const container = document.getElementById('available-drivers');
                
                if (result.success && result.data.length > 0) {
                    let html = '';
                    result.data.forEach(driver => {
                        html += `
                            <div class="driver-card mb-3 p-3 border rounded">
                                <div class="d-flex align-items-center">
                                    <div class="avatar me-3">
                                        <i class="fas fa-user-circle fa-2x text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">${driver.ten}</h6>
                                        <small class="text-muted">
                                            <i class="fas fa-car me-1"></i>${driver.loai_xe} - ${driver.so_cho_ngoi} ch·ªó
                                        </small><br>
                                        <small class="text-success">
                                            <i class="fas fa-star me-1"></i>4.8 ‚≠ê (152 ƒë√°nh gi√°)
                                        </small>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="selectDriver(${driver.id})">
                                        Ch·ªçn
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fas fa-car-crash fa-2x mb-2"></i>
                            <p>Hi·ªán t·∫°i kh√¥ng c√≥ t√†i x·∫ø kh·∫£ d·ª•ng</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Load drivers error:', error);
                document.getElementById('available-drivers').innerHTML = `
                    <div class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p>L·ªói khi t·∫£i danh s√°ch t√†i x·∫ø</p>
                    </div>
                `;
            }
        }

        // --------------------- Customer bookings (on booking page) ---------------------
        async function loadCustomerBookings() {
            try {
                if (typeof dcApp === 'undefined' || !dcApp.token) {
                    // show login prompt
                    document.getElementById('customer-bookings-card').style.display = 'none';
                    return;
                }

                document.getElementById('customer-bookings-card').style.display = '';
                const res = await fetch('/api/trips/user?limit=5', {
                    headers: { 'Authorization': `Bearer ${dcApp.token}` }
                });

                if (!res.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i ƒë∆°n');
                const result = await res.json();
                if (!result.success) throw new Error(result.message || 'L·ªói');

                const trips = result.data.trips || [];
                displayCustomerBookings(trips);
            } catch (e) {
                console.error('Load customer bookings error', e);
                const container = document.getElementById('customer-bookings-container');
                container.innerHTML = `<div class="text-center text-danger small">L·ªói khi t·∫£i ƒë∆°n: ${e.message}</div>`;
            }
        }

        function displayCustomerBookings(trips) {
            const container = document.getElementById('customer-bookings-container');
            if (!trips || trips.length === 0) {
                container.innerHTML = `<div class="text-center text-muted small">B·∫°n ch∆∞a c√≥ ƒë∆°n n√†o g·∫ßn ƒë√¢y</div>`;
                return;
            }

            let html = '<div class="list-group">';
            trips.forEach(trip => {
                const price = trip.gia_cuoc ? new Intl.NumberFormat('vi-VN').format(trip.gia_cuoc) + 'ƒë' : 'Ch∆∞a x√°c ƒë·ªãnh';
                const statusBadge = {
                    'cho_xac_nhan': '<span class="badge bg-warning text-dark">Ch·ªù x√°c nh·∫≠n</span>',
                    'da_xac_nhan': '<span class="badge bg-info">ƒê√£ x√°c nh·∫≠n</span>',
                    'dang_di': '<span class="badge bg-primary">ƒêang ƒëi</span>',
                    'hoan_thanh': '<span class="badge bg-success">Ho√†n th√†nh</span>',
                    'huy_bo': '<span class="badge bg-danger">ƒê√£ h·ªßy</span>'
                }[trip.trang_thai] || '<span class="badge bg-secondary">Kh√¥ng x√°c ƒë·ªãnh</span>';
                
                // R√∫t ng·∫Øn ƒë·ªãa ch·ªâ
                const shortenAddress = (addr) => {
                    if (!addr) return '';
                    const parts = addr.split(',');
                    if (parts.length > 3) {
                        return parts[0] + ', ' + parts[parts.length - 2].trim();
                    }
                    return parts[0];
                };
                
                const shortPickup = shortenAddress(trip.diem_don);
                const shortDest = shortenAddress(trip.diem_den);
                
                html += `
                    <div class="list-group-item list-group-item-action" style="cursor: pointer;" onclick="viewBookingDetail(${trip.id})">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="flex-grow-1" style="max-width: 70%;">
                                <div class="fw-bold mb-1">#${trip.id}</div>
                                <div class="small text-truncate" title="${trip.diem_don}">
                                    <i class="fas fa-circle text-success" style="font-size: 8px;"></i> ${shortPickup}
                                </div>
                                <div class="small text-truncate" title="${trip.diem_den}">
                                    <i class="fas fa-circle text-danger" style="font-size: 8px;"></i> ${shortDest}
                                </div>
                            </div>
                            <div class="text-end">
                                ${statusBadge}
                                <div class="fw-bold text-success mt-1">${price}</div>
                            </div>
                        </div>
                        ${trip.trang_thai === 'cho_xac_nhan' || trip.trang_thai === 'da_xac_nhan' ? `
                        <div class="text-end">
                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); cancelBooking(${trip.id});"><i class="fas fa-times me-1"></i>H·ªßy</button>
                        </div>
                        ` : ''}
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        async function viewBookingDetail(tripId) {
            try {
                // Show modal immediately
                const modal = new bootstrap.Modal(document.getElementById('tripDetailModal'));
                modal.show();
                
                // Fetch trip details
                const res = await fetch(`/api/trips/${tripId}`, { headers: { 'Authorization': `Bearer ${dcApp.token}` } });
                const result = await res.json();
                
                if (!result.success) {
                    document.getElementById('tripDetailContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>${result.message || 'Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt'}
                        </div>
                    `;
                    return;
                }

                const trip = result.data;
                const statusText = {
                    'cho_xac_nhan': 'Ch·ªù x√°c nh·∫≠n',
                    'da_xac_nhan': 'ƒê√£ x√°c nh·∫≠n',
                    'dang_di': 'ƒêang ƒëi',
                    'hoan_thanh': 'Ho√†n th√†nh',
                    'huy_bo': 'ƒê√£ h·ªßy'
                }[trip.trang_thai] || trip.trang_thai;
                
                const statusClass = {
                    'cho_xac_nhan': 'warning',
                    'da_xac_nhan': 'info',
                    'dang_di': 'primary',
                    'hoan_thanh': 'success',
                    'huy_bo': 'danger'
                }[trip.trang_thai] || 'secondary';
                
                const price = trip.gia_cuoc ? new Intl.NumberFormat('vi-VN').format(trip.gia_cuoc) + ' VND' : 'Ch∆∞a x√°c ƒë·ªãnh';
                const time = trip.thoi_gian_du_kien || trip.thoi_gian_dat || 'Ch∆∞a x√°c ƒë·ªãnh';
                
                document.getElementById('tripDetailContent').innerHTML = `
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">M√£ chuy·∫øn ƒëi</h6>
                        <p class="fw-bold">#${trip.id}</p>
                    </div>
                    <div class="mb-3">
                        <h6 class="text-muted mb-2"><i class="fas fa-map-marker-alt text-success me-2"></i>ƒêi·ªÉm ƒë√≥n</h6>
                        <p>${trip.diem_don}</p>
                    </div>
                    <div class="mb-3">
                        <h6 class="text-muted mb-2"><i class="fas fa-map-marker-alt text-danger me-2"></i>ƒêi·ªÉm ƒë·∫øn</h6>
                        <p>${trip.diem_den}</p>
                    </div>
                    <div class="mb-3">
                        <h6 class="text-muted mb-2"><i class="fas fa-clock me-2"></i>Th·ªùi gian</h6>
                        <p>${time}</p>
                    </div>
                    <div class="mb-3">
                        <h6 class="text-muted mb-2"><i class="fas fa-road me-2"></i>Kho·∫£ng c√°ch</h6>
                        <p>${trip.khoang_cach ? trip.khoang_cach + ' km' : 'Ch∆∞a x√°c ƒë·ªãnh'}</p>
                    </div>
                    <div class="mb-3">
                        <h6 class="text-muted mb-2"><i class="fas fa-money-bill-wave me-2"></i>Gi√° c∆∞·ªõc</h6>
                        <p class="text-success fw-bold fs-5">${price}</p>
                    </div>
                    <div class="mb-3">
                        <h6 class="text-muted mb-2"><i class="fas fa-info-circle me-2"></i>Tr·∫°ng th√°i</h6>
                        <p><span class="badge bg-${statusClass}">${statusText}</span></p>
                    </div>
                    ${trip.ghi_chu ? `
                    <div class="mb-3">
                        <h6 class="text-muted mb-2"><i class="fas fa-sticky-note me-2"></i>Ghi ch√∫</h6>
                        <p>${trip.ghi_chu}</p>
                    </div>
                    ` : ''}
                    ${trip.ten_tai_xe ? `
                    <div class="mb-3">
                        <h6 class="text-muted mb-2"><i class="fas fa-user me-2"></i>T√†i x·∫ø</h6>
                        <p>${trip.ten_tai_xe}${trip.sdt_tai_xe ? ' - ' + trip.sdt_tai_xe : ''}</p>
                    </div>
                    ` : ''}
                `;
            } catch (e) {
                console.error('View booking detail error', e);
                document.getElementById('tripDetailContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>L·ªói khi l·∫•y chi ti·∫øt ƒë∆°n
                    </div>
                `;
            }
        }

        async function cancelBooking(tripId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n n√†y?')) return;
            try {
                const res = await fetch(`/api/trips/${tripId}/cancel`, { method: 'POST', headers: { 'Authorization': `Bearer ${dcApp.token}`, 'Content-Type': 'application/json' } });
                const result = await res.json();
                if (result.success) {
                    showNotification('success', 'ƒê√£ h·ªßy ƒë∆°n th√†nh c√¥ng');
                    loadCustomerBookings();
                } else {
                    showNotification('error', result.message || 'Kh√¥ng th·ªÉ h·ªßy ƒë∆°n');
                }
            } catch (e) {
                console.error('Cancel booking error', e);
                showNotification('error', 'L·ªói khi h·ªßy ƒë∆°n');
            }
        }

        async function submitBooking() {
            // Check if user is logged in
            if (typeof dcApp === 'undefined' || !dcApp.token) {
                showNotification('warning', 'Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t xe');
                return;
            }

            // Ensure price/distance are calculated and available
            try { await calculatePrice(); } catch (e) { console.debug('calculatePrice failed before submit', e); }

            const pickupInput = document.getElementById('pickup-location');
            const destinationInput = document.getElementById('destination');

            const lat_don = parseFloat(pickupInput.getAttribute('data-lat')) || null;
            const lng_don = parseFloat(pickupInput.getAttribute('data-lng')) || null;
            const lat_den = parseFloat(destinationInput.getAttribute('data-lat')) || null;
            const lng_den = parseFloat(destinationInput.getAttribute('data-lng')) || null;

            // Promotion data (if promotionService available)
            let khuyen_mai_id = null;
            let so_tien_giam_gia = 0;
            try {
                if (typeof promotionService !== 'undefined' && promotionService.getAppliedPromotion()) {
                    const p = promotionService.getAppliedPromotion();
                    khuyen_mai_id = p.id || null;
                    so_tien_giam_gia = parseFloat(p.gia_tri_giam) || 0;
                }
            } catch (e) { console.debug('No promotion data', e); }

            const formData = {
                diem_don: pickupInput.value,
                diem_den: destinationInput.value,
                lat_don: lat_don,
                lng_don: lng_don,
                lat_den: lat_den,
                lng_den: lng_den,
                khoang_cach: parseFloat(window.lastCalculatedDistance) || 0,
                thoi_gian_du_kien: document.getElementById('pickup-date').value + ' ' + document.getElementById('pickup-time').value,
                loai_xe: document.getElementById('car-type').value,
                so_hanh_khach: parseInt(document.getElementById('passengers').value) || 1,
                gia_cuoc: parseFloat(window.lastCalculatedTotal) || 0,
                phi_dich_vu: 0,
                khuyen_mai_id: khuyen_mai_id,
                so_tien_giam_gia: so_tien_giam_gia,
                ghi_chu: document.getElementById('note').value || null,
                phuong_thuc_thanh_toan: document.querySelector('input[name="paymentMethod"]:checked').value
            };

            // Basic client-side validation to avoid server-side 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá'
            if (!formData.diem_don || formData.diem_don.length < 5) {
                showNotification('warning', 'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë√≥n h·ª£p l·ªá (√≠t nh·∫•t 5 k√Ω t·ª±)');
                return;
            }
            if (!formData.diem_den || formData.diem_den.length < 5) {
                showNotification('warning', 'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë·∫øn h·ª£p l·ªá (√≠t nh·∫•t 5 k√Ω t·ª±)');
                return;
            }
            if (!formData.khoang_cach || formData.khoang_cach <= 0) {
                showNotification('warning', 'Vui l√≤ng t√≠nh gi√° ƒë·ªÉ x√°c ƒë·ªãnh kho·∫£ng c√°ch tr∆∞·ªõc khi ƒë·∫∑t xe');
                return;
            }
            if (!formData.gia_cuoc || formData.gia_cuoc < 1000) {
                showNotification('warning', 'Gi√° c∆∞·ªõc kh√¥ng h·ª£p l·ªá. Vui l√≤ng t√≠nh gi√° v√† th·ª≠ l·∫°i');
                return;
            }

            try {
                const response = await fetch('/api/trips', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${dcApp?.token || ''}`
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('success', 'ƒê·∫∑t xe th√†nh c√¥ng! Chuy·∫øn ƒëi c·ªßa b·∫°n ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω.');
                    document.getElementById('booking-form').reset();
                    
                    // Redirect to trips page after 2 seconds
                    setTimeout(() => {
                        window.location.href = 'trips.html';
                    }, 2000);
                } else {
                    showNotification('error', result.message || 'ƒê·∫∑t xe th·∫•t b·∫°i');
                }
            } catch (error) {
                console.error('Booking error:', error);
                showNotification('error', 'L·ªói khi ƒë·∫∑t xe');
            }
        }

        function selectDriver(driverId) {
            showNotification('info', 'T√≠nh nƒÉng ch·ªçn t√†i x·∫ø c·ª• th·ªÉ s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t trong phi√™n b·∫£n ti·∫øp theo');
        }

        function viewPromotions() {
            window.location.href = 'promotions.html';
        }

        function callSupport() {
            showNotification('info', 'ƒêang chuy·ªÉn ƒë·∫øn ·ª©ng d·ª•ng g·ªçi ƒëi·ªán...');
            window.open('tel:19001234');
        }

        // Test map initialization
        function testMapInit() {
            console.log('=== MAP INITIALIZATION TEST ===');
            console.log('Leaflet available:', typeof L !== 'undefined');
            console.log('Map container exists:', !!document.getElementById('map'));
            console.log('Current map object:', map);
            console.log('osmtogeojson available:', typeof osmtogeojson !== 'undefined');
            console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
            
            showNotification('info', 'Ki·ªÉm tra console ƒë·ªÉ xem th√¥ng tin debug');
            
            // Force open modal and init map
            try {
                const modalElement = document.getElementById('mapModal');
                if (modalElement) {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                    
                    setTimeout(() => {
                        if (!map) {
                            console.log('Map not initialized, trying now...');
                            initMap();
                        } else {
                            console.log('Map already exists, refreshing...');
                            map.invalidateSize();
                        }
                    }, 1000);
                } else {
                    console.error('Modal element not found');
                }
            } catch (error) {
                console.error('Modal open error:', error);
                showNotification('error', 'L·ªói m·ªü modal: ' + error.message);
            }
        }

        // Test destination button
        function testDestinationButton() {
            console.log('üß™ Testing destination button...');
            
            const destBtn = document.getElementById('destination-map-btn');
            console.log('Destination button found:', !!destBtn);
            
            if (destBtn) {
                console.log('Destination button element:', destBtn);
                console.log('Button onclick:', destBtn.onclick);
                
                // Manual trigger
                console.log('Manually triggering destination button...');
                setMapMode('destination');
                
                const modal = new bootstrap.Modal(document.getElementById('mapModal'));
                modal.show();
            } else {
                console.error('‚ùå Destination button not found!');
            }
        }

        // Test destination button
        function testDestinationButton() {
            console.log('=== TESTING DESTINATION BUTTON ===');
            const destinationBtn = document.getElementById('destination-map-btn');
            const destinationInput = document.getElementById('destination');
            
            console.log('Destination button element:', destinationBtn);
            console.log('Destination input element:', destinationInput);
            console.log('Button exists:', !!destinationBtn);
            console.log('Input exists:', !!destinationInput);
            
            if (destinationBtn) {
                console.log('Button properties:', {
                    id: destinationBtn.id,
                    className: destinationBtn.className,
                    onclick: destinationBtn.onclick,
                    style: destinationBtn.style.cssText
                });
                
                // Simulate click
                console.log('Simulating click...');
                destinationBtn.click();
            } else {
                console.error('‚ùå Destination button not found in DOM!');
            }
            
            showNotification('info', 'Ki·ªÉm tra Console ƒë·ªÉ xem k·∫øt qu·∫£ test');
        }
    </script>

    <!-- Modal Chi ti·∫øt chuy·∫øn ƒëi -->
    <div class="modal fade" id="tripDetailModal" tabindex="-1" aria-labelledby="tripDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="tripDetailModalLabel">
                        <i class="fas fa-info-circle me-2"></i>Chi ti·∫øt chuy·∫øn ƒëi
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="tripDetailContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>ƒê√≥ng
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer -->
    <footer class="bg-dark text-light py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5 class="text-white"><i class="fas fa-car"></i> DC Car Booking</h5>
                    <p class="text-light opacity-75">H·ªá th·ªëng ƒë·∫∑t xe tr·ª±c tuy·∫øn h√†ng ƒë·∫ßu Vi·ªát Nam</p>
                    <div class="mt-3">
                        <img src="/uploads/bocongthuong/Logo-thong-bao-mau-do-1.png" 
                             alt="ƒê√£ ƒëƒÉng k√Ω B·ªô C√¥ng Th∆∞∆°ng" 
                             style="height: 150px; object-fit: contain;"
                             onerror="this.style.display='none'">
                    </div>
                </div>
                <div class="col-md-4">
                    <h6 class="text-white mb-3">Li√™n h·ªá</h6>
                    <div class="text-light opacity-75">
                        <p class="mb-2"><i class="fas fa-phone"></i> Hotline: <a href="tel:19006789" class="text-light text-decoration-none">1900 6789</a></p>
                        <p class="mb-2"><i class="fas fa-envelope"></i> Email: <a href="mailto:support@dcbooking.com" class="text-light text-decoration-none">support@dcbooking.com</a></p>
                        <p class="mb-2"><i class="fab fa-facebook"></i> Facebook: <a href="https://web.facebook.com/manhcuonq204" target="_blank" class="text-light text-decoration-none">DC Booking</a></p>
                    </div>
                </div>
                <div class="col-md-4">
                    <h6 class="text-white mb-3">ƒê·ªãa ch·ªâ</h6>
                    <p class="text-light opacity-75">
                        <i class="fas fa-map-marker-alt"></i> Tr·ª• s·ªü:<br>
                        HUTECH - ƒê·∫°i h·ªçc C√¥ng ngh·ªá TP.HCM (Thu Duc Campus)<br>
                        Khu C√¥ng ngh·ªá cao XLHN, Hi·ªáp Ph√∫,<br>
                         Th·ªß ƒê·ª©c, Th√†nh ph·ªë H·ªì Ch√≠ Minh, Vi·ªát Nam
                    </p>
                </div>
            </div>
            <hr class="border-secondary my-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="text-light opacity-75 mb-0">¬© 2024 DC Car Booking. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

</body>
</html>
