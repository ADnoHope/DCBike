<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đánh giá tài xế - DC Booking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
        }
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .content-wrapper {
            flex: 1 0 auto;
        }
        .review-item {
            transition: all 0.2s;
        }
        .review-item:hover {
            background-color: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-group .btn {
            font-size: 0.875rem;
        }
        .driver-info-details p {
            font-size: 0.95rem;
        }
        footer {
            flex-shrink: 0;
        }
        /* Thêm style cho avatar tròn đẹp hơn */
        .avatar-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <button class="btn btn-link text-white p-0 me-3" id="sidebar-toggle" type="button">
                <i class="fas fa-bars fa-lg"></i>
            </button>
            <a class="navbar-brand fw-bold" href="/index.html">
                <i class="fas fa-car"></i> DC Booking
            </a>
            <div class="ms-auto">
                <button class="btn btn-outline-light" onclick="goBack()">
                    <i class="fas fa-arrow-left me-2"></i>Quay lại
                </button>
            </div>
        </div>
    </nav>

    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <div class="sidebar-menu" id="sidebar-menu">
        <div class="sidebar-header">
            <h5 class="mb-0"><i class="fas fa-car"></i> Menu</h5>
            <button class="btn-close btn-close-white" id="sidebar-close"></button>
        </div>
        <div class="sidebar-body">
            <div class="status-toggle-container mb-3" id="driver-status-section">
                <div class="status-toggle" id="status-container">
                    <div>
                        <h6 class="mb-0" id="status-title">
                            <i class="fas fa-circle me-2" id="status-icon"></i>
                            <span id="status-text">Đang tải...</span>
                        </h6>
                        <small class="text-muted" id="status-description">Đang kiểm tra trạng thái</small>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="statusToggle" onchange="toggleDriverStatus()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="mt-2 text-center" id="status-info">
                    <small class="text-muted">Bật để nhận chuyến đi mới</small>
                </div>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item d-none" id="home-nav-sidebar">
                    <a class="nav-link" href="/index.html"><i class="fas fa-home me-2"></i>Trang chủ</a>
                </li>
                <li class="nav-item d-none" id="booking-nav-sidebar">
                    <a class="nav-link" href="booking.html" data-auth><i class="fas fa-calendar-check me-2"></i>Đặt xe</a>
                </li>
                <li class="nav-item d-none" id="trips-nav-sidebar">
                    <a class="nav-link" href="trips.html" data-auth><i class="fas fa-route me-2"></i>Chuyến đi</a>
                </li>
                <li class="nav-item d-none" id="drivers-nav-sidebar">
                    <a class="nav-link" href="drivers.html"><i class="fas fa-user-tie me-2"></i>Tài xế</a>
                </li>
                <li class="nav-item d-none" id="stats-menu-item-sidebar">
                    <a class="nav-link" href="driver-dashboard.html"><i class="fas fa-chart-bar me-2"></i>Thống kê</a>
                </li>
                <li class="nav-item d-none" id="promotions-nav-sidebar">
                    <a class="nav-link" href="promotions.html"><i class="fas fa-gift me-2"></i>Khuyến mãi</a>
                </li>
                <li class="nav-item d-none" id="driverreg-nav-sidebar">
                    <a class="nav-link" href="/driver-registration.html"><i class="fas fa-user-plus me-2"></i>Đăng ký tài xế</a>
                </li>
            </ul>
        </div>
    </div>

    <div class="container mt-4 content-wrapper">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3 text-center">
                                <img id="driver-avatar" src="/uploads/avatars/default-avatar.svg" alt="Avatar" style="width:96px;height:96px;border-radius:50%;object-fit:cover;border:6px solid #fff;box-shadow:0 6px 20px rgba(0,0,0,0.12);" />
                            </div>
                            <div class="col-md-9">
                                <h3 class="mb-1" id="driver-name">Đang tải...</h3>
                                <div class="d-flex align-items-center mb-2">
                                    <div id="driver-rating" class="me-3"></div>
                                    <span class="text-muted" id="driver-stats"></span>
                                </div>
                                <div class="driver-info-details" id="driver-details">
                                    <p class="mb-1"><i class="fas fa-car text-primary me-2"></i><span id="driver-vehicle"></span></p>
                                    <p class="mb-1"><i class="fas fa-hashtag text-primary me-2"></i><span id="driver-plate"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-star text-warning me-2"></i>
                                Tất cả đánh giá (<span id="total-reviews">0</span>)
                            </h5>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary active" data-filter="all">Tất cả</button>
                                <button type="button" class="btn btn-sm btn-outline-primary" data-filter="5">5 <i class="fas fa-star"></i></button>
                                <button type="button" class="btn btn-sm btn-outline-primary" data-filter="4">4 <i class="fas fa-star"></i></button>
                                <button type="button" class="btn btn-sm btn-outline-primary" data-filter="3">3 <i class="fas fa-star"></i></button>
                                <button type="button" class="btn btn-sm btn-outline-primary" data-filter="2">2 <i class="fas fa-star"></i></button>
                                <button type="button" class="btn btn-sm btn-outline-primary" data-filter="1">1 <i class="fas fa-star"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="reviews-loading" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Đang tải...</span>
                            </div>
                            <p class="mt-3 text-muted">Đang tải đánh giá...</p>
                        </div>

                        <div id="reviews-list" style="display: none;"></div>

                        <div id="no-reviews" class="text-center py-5" style="display: none;">
                            <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Chưa có đánh giá nào</h5>
                            <p class="text-muted">Tài xế này chưa nhận được đánh giá từ khách hàng.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/notifications.js"></script>
    <script src="/js/app.js"></script>
    <script>
        // Ẩn driver status nếu không phải tài xế
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Giả định role lưu trong localStorage với key 'role' hoặc trong user object
                let role = localStorage.getItem('role');
                if (!role && localStorage.getItem('user')) {
                    const user = JSON.parse(localStorage.getItem('user'));
                    role = user && user.role ? user.role : null;
                }
                if (role !== 'tai_xe') {
                    const statusSection = document.getElementById('driver-status-section');
                    if (statusSection) statusSection.style.display = 'none';
                }
            } catch (e) { /* ignore */ }
        });
        async function loadDriverStatus() { try { const token = localStorage.getItem('token'); if(!token) return; const res = await fetch(`${window.API_BASE_URL}/drivers/my-status`, { headers: { 'Authorization': `Bearer ${token}` } }); const data = await res.json(); if (data && data.success && data.data) updateStatusUI(data.data.trang_thai_tai_xe); } catch (e) { console.debug(e); } }
        function updateStatusUI(status) { const container = document.getElementById('status-container'); const toggle = document.getElementById('statusToggle'); const icon = document.getElementById('status-icon'); const text = document.getElementById('status-text'); const description = document.getElementById('status-description'); if (!container||!toggle) return; if (status==='san_sang') { container.classList.add('active'); container.classList.remove('inactive'); toggle.checked=true; icon.className='fas fa-circle me-2'; text.textContent='Đang hoạt động'; description.textContent='Bạn có thể nhận chuyến đi mới'; } else { container.classList.remove('active'); container.classList.add('inactive'); toggle.checked=false; icon.className='fas fa-moon me-2'; text.textContent='Không hoạt động'; description.textContent='Bật để bắt đầu nhận chuyến'; } }
        async function toggleDriverStatus() { const toggle=document.getElementById('statusToggle'); if(!toggle) return; const newStatus = toggle.checked ? 'san_sang' : 'nghi_lam'; try { const token = localStorage.getItem('token'); const res = await fetch(`${window.API_BASE_URL}/drivers/status`, { method:'POST', headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${token}` }, body: JSON.stringify({ trang_thai: newStatus }) }); const data = await res.json(); if (data && data.success) { updateStatusUI(newStatus); showNotification(toggle.checked ? 'Đã bật trạng thái hoạt động' : 'Đã tắt trạng thái hoạt động','success'); } else { toggle.checked = !toggle.checked; showNotification('Không thể thay đổi trạng thái','error'); } } catch (e) { console.error(e); toggle.checked = !toggle.checked; showNotification('Lỗi khi thay đổi trạng thái','error'); } }
        document.addEventListener('DOMContentLoaded', () => setTimeout(loadDriverStatus, 600));
    </script>
    
    <script>
        // LOGIC CHÍNH (ĐÃ SỬA LỖI ẢNH)
        const apiBaseUrl = (window.API_BASE_URL && window.API_BASE_URL.replace(/\/$/, '')) || '/api';
        let allReviews = [];
        let currentFilter = 'all';
        let driverId = null;

        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        function initDriverId() {
            driverId = getUrlParameter('id');
            if (!driverId) {
                alert('Không tìm thấy thông tin tài xế');
                window.location.href = '/views/drivers.html';
                return false;
            }
            return true;
        }

        function goBack() {
            window.location.href = '/views/drivers.html';
        }

        // 1. HÀM XỬ LÝ ĐƯỜNG DẪN ẢNH (FIX LỖI QUAN TRỌNG)
        // Hàm này kiểm tra xem path đã có /uploads hay chưa để tránh double path
        function resolveAvatarPath(path) {
            if (!path || path === 'null') return '/uploads/avatars/default-avatar.svg';
            
            // Nếu trong DB đã lưu đường dẫn đầy đủ (/uploads/...) hoặc là link http
            if (path.startsWith('/uploads') || path.startsWith('http')) {
                return path; 
            }
            
            // Nếu DB chỉ lưu tên file (ví dụ: image123.jpg)
            return `/uploads/avatars/${path}`;
        }

        // 2. Hàm tạo Avatar chữ cái (Fallback)
        function getInitialsAvatar(name) {
            const initial = name ? name.charAt(0).toUpperCase() : 'U';
            const colors = ['#1abc9c', '#2ecc71', '#3498db', '#9b59b6', '#34495e', '#e67e22', '#e74c3c'];
            const color = colors[name.length % colors.length];
            return `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100'><rect width='100' height='100' fill='${encodeURIComponent(color)}'/><text x='50%' y='50%' font-size='50' fill='white' text-anchor='middle' dy='.35em' font-family='Arial'>${initial}</text></svg>`;
        }

        async function loadDriverInfo() {
            if (!driverId) return;
            
            try {
                const response = await fetch(`${apiBaseUrl}/drivers/public/${driverId}`);
                const data = await response.json();

                if (data && data.success && data.data) {
                    const driver = data.data;
                    document.getElementById('driver-name').textContent = driver.ten || 'Tài xế';
                    
                    // Sử dụng hàm resolveAvatarPath cho avatar tài xế
                    const avatarPath = resolveAvatarPath(driver.avatar || driver.hinh_anh);
                    const imgEl = document.getElementById('driver-avatar');
                    imgEl.src = avatarPath;
                    imgEl.onerror = () => { imgEl.src = '/uploads/avatars/default-avatar.svg'; };

                    const rating = Number(driver.diem_danh_gia || 0);
                    document.getElementById('driver-rating').innerHTML = generateStars(rating);
                    document.getElementById('driver-stats').textContent = `${rating.toFixed(1)} ★ (${driver.so_luot_danh_gia || 0} lượt) • ${driver.so_chuyen_di || 0} chuyến`;
                    
                    const vehicle = `${driver.hang_xe || ''} ${driver.mau_xe || ''} - ${driver.loai_xe || ''} ${driver.so_cho_ngoi || 4} chỗ`;
                    document.getElementById('driver-vehicle').textContent = vehicle.trim();
                    document.getElementById('driver-plate').textContent = `Biển số: ${driver.bien_so_xe || 'N/A'}`;
                }
            } catch (error) {
                console.error('Load driver info error:', error);
            }
        }

        async function loadReviews() {
            if (!driverId) return;
            
            try {
                const response = await fetch(`${apiBaseUrl}/drivers/public/${driverId}/reviews`);
                document.getElementById('reviews-loading').style.display = 'none';

                if (!response.ok) {
                    document.getElementById('no-reviews').style.display = 'block';
                    return;
                }

                const data = await response.json();

                if (data && data.success && Array.isArray(data.data) && data.data.length > 0) {
                    allReviews = data.data;
                    console.debug('Reviews loaded for driver', driverId, allReviews);
                    filterReviews('all');
                    document.getElementById('total-reviews').textContent = allReviews.length;
                    document.getElementById('reviews-list').style.display = 'block';
                } else {
                    document.getElementById('no-reviews').style.display = 'block';
                }
            } catch (error) {
                console.error('Load reviews error:', error);
                document.getElementById('reviews-loading').style.display = 'none';
                document.getElementById('no-reviews').style.display = 'block';
            }
        }

        document.querySelectorAll('.btn-group .btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                const filter = e.target.dataset.filter;
                filterReviews(filter);
            });
        });

        function filterReviews(filter) {
            let filtered = allReviews;
            if (filter !== 'all') {
                filtered = allReviews.filter(r => Math.floor(r.diem_so) == filter);
            }
            displayReviews(filtered);
        }

        function displayReviews(reviews) {
            const container = document.getElementById('reviews-list');

            if (!reviews || reviews.length === 0) {
                container.innerHTML = '<p class="text-center text-muted mt-3">Không có đánh giá nào.</p>';
                return;
            }

            container.innerHTML = reviews.map(review => {
                const date = new Date(review.created_at);
                const formattedDate = date.toLocaleDateString('vi-VN', {
                    year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });

                // Lấy tên người đánh giá
                const reviewerName = review.ten_nguoi_danh_gia || review.name || (review.user ? review.user.ten : 'Khách hàng');

                // TÌM AVATAR TỪ CÁC TRƯỜNG KHÁC NHAU
                // Ưu tiên: nguoi_danh_gia_avatar (từ JOIN) -> khach_hang_avatar -> user.avatar -> avatar -> ảnh chữ cái
                let rawAvatar = review.nguoi_danh_gia_avatar || review.khach_hang_avatar || (review.user && review.user.avatar) || review.avatar;
                const avatarSrc = resolveAvatarPath(rawAvatar);

                return `
                    <div class="review-item mb-3 p-3 border rounded">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="d-flex align-items-center">
                                <img src="${avatarSrc}" 
                                     alt="${reviewerName}" 
                                     class="avatar-circle me-3"
                                     onerror="this.src='${getInitialsAvatar(reviewerName)}'" />
                                <div>
                                    <strong class="text-primary d-block mb-0">${reviewerName}</strong>
                                    <div class="mt-1">
                                        ${generateStars(review.diem_so)}
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>${formattedDate}
                            </small>
                        </div>
                        ${review.binh_luan ? `
                            <p class="mb-0 text-muted ms-5 ps-2">
                                ${review.binh_luan}
                            </p>
                        ` : '<p class="mb-0 text-muted ms-5 ps-2 fst-italic small">Không có bình luận</p>'}
                    </div>
                `;
            }).join('');
        }

        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            let stars = '<span class="text-warning">';
            for (let i = 0; i < fullStars; i++) stars += '<i class="fas fa-star"></i>';
            if (hasHalfStar) stars += '<i class="fas fa-star-half-alt"></i>';
            for (let i = 0; i < emptyStars; i++) stars += '<i class="far fa-star"></i>';
            stars += '</span>';
            return stars;
        }

        if (initDriverId()) {
            loadDriverInfo();
            loadReviews();
        }
    </script>

    <footer class="bg-dark text-light py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5 class="text-white"><i class="fas fa-car"></i> DC Car Booking</h5>
                    <p class="text-light opacity-75">Hệ thống đặt xe trực tuyến hàng đầu Việt Nam</p>
                    <div class="mt-3">
                        <img src="/uploads/bocongthuong/Logo-thong-bao-mau-do-1.png" 
                             alt="Đã đăng ký Bộ Công Thương" 
                             style="height: 150px; object-fit: contain;"
                             onerror="this.style.display='none'">
                    </div>
                </div>
                <div class="col-md-4">
                    <h6 class="text-white mb-3">Liên hệ</h6>
                    <div class="text-light opacity-75">
                        <p class="mb-2"><i class="fas fa-phone"></i> Hotline: <a href="tel:19006789" class="text-light text-decoration-none">1900 6789</a></p>
                        <p class="mb-2"><i class="fas fa-envelope"></i> Email: <a href="mailto:support@dcbooking.com" class="text-light text-decoration-none">support@dcbooking.com</a></p>
                        <p class="mb-2"><i class="fab fa-facebook"></i> Facebook: <a href="https://web.facebook.com/manhcuonq204" target="_blank" class="text-light text-decoration-none">DC Booking</a></p>
                    </div>
                </div>
                <div class="col-md-4">
                    <h6 class="text-white mb-3">Địa chỉ</h6>
                    <p class="text-light opacity-75">
                        <i class="fas fa-map-marker-alt"></i> Trụ sở:<br>
                        HUTECH - Đại học Công nghệ TP.HCM (Thu Duc Campus)<br>
                        Khu Công nghệ cao XLHN, Hiệp Phú,<br>
                         Thủ Đức, Thành phố Hồ Chí Minh, Việt Nam
                    </p>
                </div>
            </div>
            <hr class="border-secondary my-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="text-light opacity-75 mb-0">© 2024 DC Car Booking. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>
</body>
</html>