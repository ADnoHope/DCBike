<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hoàn thiện hồ sơ tài xế</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-md-8 col-lg-6">
        <div class="card p-4">
          <h4 class="mb-3">Hoàn thiện hồ sơ tài xế</h4>
          <p class="text-muted">Bạn đã tạo tài khoản. Vui lòng cung cấp thông tin xe và bằng lái để hoàn tất.</p>

          <form id="driverInfoForm">
            <div class="mb-3">
              <label class="form-label">Họ tên</label>
              <input class="form-control" name="ho_ten" id="ho_ten" readonly />
            </div>
            <div class="mb-3 row">
              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input class="form-control" name="email" id="email" readonly />
              </div>
              <div class="col-md-6">
                <label class="form-label">Số điện thoại</label>
                <input class="form-control" name="so_dien_thoai" id="so_dien_thoai" readonly />
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">CCCD / CMND *</label>
              <input class="form-control" name="cccd" id="cccd" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Số bằng lái *</label>
              <input class="form-control" name="so_bang_lai" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Loại bằng lái *</label>
              <select class="form-select" name="bang_lai" required>
                <option value="">Chọn...</option>
                <option value="B1">B1</option>
                <option value="B2">B2</option>
                <option value="C">C</option>
                <option value="D">D</option>
                <option value="E">E</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Kinh nghiệm lái (năm)</label>
              <input type="number" class="form-control" name="kinh_nghiem_lien_tuc" min="0" value="0" />
            </div>
            <div class="mb-3">
              <label class="form-label">Biển số xe *</label>
              <input class="form-control" name="bien_so_xe" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Loại xe *</label>
              <input class="form-control" name="loai_xe" required />
            </div>
            <div class="mb-3 row">
              <div class="col-md-6">
                <label class="form-label">Màu xe</label>
                <input class="form-control" name="mau_xe" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Hãng xe</label>
                <input class="form-control" name="hang_xe" />
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Số chỗ ngồi</label>
              <input type="number" class="form-control" name="so_cho_ngoi" min="1" value="4" />
            </div>

            <div class="d-grid">
              <button class="btn btn-primary" type="submit">Hoàn tất hồ sơ</button>
            </div>
          </form>

        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE_URL = window.location.origin + '/api';

    // Submit registration to admin (create driver registration awaiting approval)
    async function submitDriverRegistration(token, data) {
      const res = await fetch(API_BASE_URL + '/auth/register-driver', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(data)
      });
      return res.json();
    }

    // Get logged-in user profile to prefill name/email/phone
    async function fetchProfile(token) {
      const res = await fetch(API_BASE_URL + '/auth/profile', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (!res.ok) throw new Error('Không thể lấy thông tin người dùng');
      return res.json();
    }

    document.getElementById('driverInfoForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const form = new FormData(this);
      const data = Object.fromEntries(form);

      // simple validation
  const required = ['so_bang_lai','bang_lai','bien_so_xe','loai_xe','cccd'];
      for (const k of required) {
        if (!data[k] || String(data[k]).trim() === '') {
          alert('Vui lòng điền đầy đủ thông tin bắt buộc');
          return;
        }
      }

      const token = localStorage.getItem('token');
      if (!token) {
        alert('Bạn cần đăng nhập trước khi hoàn tất hồ sơ tài xế');
        window.location.href = '/';
        return;
      }

      try {
        // Add user identity fields from local profile (already prefilled but ensure)
        data.ho_ten = document.getElementById('ho_ten').value || '';
        data.email = document.getElementById('email').value || '';
        data.so_dien_thoai = document.getElementById('so_dien_thoai').value || '';

        const result = await submitDriverRegistration(token, data);
        if (result.success) {
          alert('Đã gửi yêu cầu đăng ký tài xế. Vui lòng chờ admin duyệt.');
          window.location.href = '/views/profile.html';
        } else {
          // handle field-specific error if provided
          if (result.field) {
            const el = document.querySelector(`[name="${result.field}"]`);
            if (el) el.focus();
          }
          alert('Lỗi: ' + (result.message || 'Không thể gửi đăng ký'));
        }
      } catch (err) {
        console.error(err);
        alert('Lỗi hệ thống');
      }
    });

    // On load, prefill user info
    window.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Bạn cần đăng nhập để hoàn tất hồ sơ tài xế');
        window.location.href = '/index.html';
        return;
      }

      try {
        const profileResp = await fetchProfile(token);
        if (profileResp && profileResp.data) {
          const p = profileResp.data;
          document.getElementById('ho_ten').value = p.ten || '';
          document.getElementById('email').value = p.email || '';
          document.getElementById('so_dien_thoai').value = p.so_dien_thoai || '';
        }
      } catch (err) {
        console.error('Error fetching profile:', err);
      }
    });
  </script>
</body>
</html>
